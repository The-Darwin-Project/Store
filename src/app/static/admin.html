<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darwin Store Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/shared.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1>Darwin Store Admin</h1>
                <button class="admin-logout-btn" onclick="adminLogout()" title="Logout">Logout</button>
            </div>
            <p class="subtitle">Back Office Management</p>
            <div class="search-bar" style="margin-top: 1rem;">
                <input type="text" id="global-search" placeholder="Search..." style="width: 100%; max-width: 500px;">
            </div>
        </header>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" type="button" role="tab" onclick="switchTab('dashboard')">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inventory-tab" type="button" role="tab" onclick="switchTab('inventory')">Inventory</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" type="button" role="tab" onclick="switchTab('orders')">Orders</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="customers-tab" type="button" role="tab" onclick="switchTab('customers')">Customers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="suppliers-tab" type="button" role="tab" onclick="switchTab('suppliers')">Suppliers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-tab" type="button" role="tab" onclick="switchTab('alerts')">Alerts <span id="alerts-badge" class="badge bg-danger" style="font-size: 0.7rem; vertical-align: top; display: none;">0</span></button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="coupons-tab" type="button" role="tab" onclick="switchTab('coupons')">Coupons</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaigns-tab" type="button" role="tab" onclick="switchTab('campaigns')">Campaigns</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoices-tab" type="button" role="tab" onclick="switchTab('invoices')">Invoices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" type="button" role="tab" onclick="switchTab('settings')">Settings</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane active" id="dashboard">
                <div class="panel">
                    <h2>Total Revenue</h2>
                    <div id="dashboard-revenue" style="font-size: 2rem; font-weight: 700; color: var(--success);">$0.00</div>
                </div>
                <div class="panel">
                    <h2>Orders by Status</h2>
                    <div id="dashboard-orders-status" class="empty-state">No orders yet.</div>
                </div>
                <div class="panel">
                    <h2>Top 5 Products by Sales</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Product</th>
                                    <th>Units Sold</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-top-products">
                                <tr><td colspan="3" class="empty-state">No sales data yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="panel">
                    <h2>Low Stock Alerts</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Stock</th>
                                    <th>Reorder At</th>
                                    <th>Supplier</th>
                                    <th>Contact</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-low-stock">
                                <tr><td colspan="5" class="empty-state">No low-stock items.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="tab-pane" id="inventory">
                <!-- Add Product Form -->
                <div class="panel">
                    <h2>Add Product</h2>
                    <form id="add-form">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="add-name">Name</label>
                                <input type="text" id="add-name" placeholder="Product name" required>
                            </div>
                            <div class="form-group flex-grow">
                                <label for="add-sku">SKU</label>
                                <input type="text" id="add-sku" placeholder="Product SKU" required>
                            </div>
                            <div class="form-group">
                                <label for="add-price">Price ($)</label>
                                <input type="number" id="add-price" step="0.01" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="add-stock">Stock</label>
                                <input type="number" id="add-stock" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="add-reorder">Reorder At</label>
                                <input type="number" id="add-reorder" min="0" value="10">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="add-supplier">Supplier</label>
                                <select id="add-supplier">
                                    <option value="">-- No supplier --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="add-image">Image</label>
                                <input type="file" id="add-image" accept="image/*">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="add-description">Description</label>
                            <textarea id="add-description" rows="2" placeholder="Product description (optional)"></textarea>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button type="submit">Add Product</button>
                        </div>
                    </form>
                </div>

                <!-- Product Table -->
                <div class="panel">
                    <h2>Product Inventory</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>SKU</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Supplier</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="product-table">
                                <tr>
                                    <td colspan="8" class="empty-state">No products yet. Add one above!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div class="tab-pane" id="orders">
                <div class="panel">
                    <h2>Order History</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order ID</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <tr><td colspan="4" class="empty-state">No orders yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel" style="margin-top: 1.5rem;">
                    <h2>Unassigned Orders (Legacy)</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order ID</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unassigned-orders-table">
                                <tr><td colspan="5" class="empty-state">No unassigned orders.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div class="tab-pane" id="customers">
                <div class="panel">
                    <h2>Add Customer</h2>
                    <form id="add-customer-form">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="cust-name">Name</label>
                                <input type="text" id="cust-name" placeholder="Customer name" required>
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-email">Email</label>
                                <input type="email" id="cust-email" placeholder="customer@example.com" required>
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-company">Company</label>
                                <input type="text" id="cust-company" placeholder="Company name">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-phone">Phone</label>
                                <input type="text" id="cust-phone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 0.75rem;">
                            <div class="form-group flex-grow">
                                <label for="cust-street">Street</label>
                                <input type="text" id="cust-street" placeholder="Street address">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-city">City</label>
                                <input type="text" id="cust-city" placeholder="City">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-state">State</label>
                                <input type="text" id="cust-state" placeholder="State">
                            </div>
                            <div class="form-group">
                                <label for="cust-zip">Zip</label>
                                <input type="text" id="cust-zip" placeholder="Zip" style="width: 100px;">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="cust-country">Country</label>
                                <input type="text" id="cust-country" placeholder="Country">
                            </div>
                            <div class="form-group">
                                <button type="submit">Add Customer</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <h2>Customer List</h2>
                    <div id="customer-list">
                        <div class="empty-state">No customers yet.</div>
                    </div>
                </div>
                <div class="panel" id="customer-detail-panel" style="display: none;">
                    <h2 id="customer-detail-title">Customer Details</h2>
                    <div id="customer-detail-content"></div>
                </div>
                <div class="panel customer-orders-section" id="customer-orders-panel" style="display: none;">
                    <h2 id="customer-orders-title">Customer Orders</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order ID</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-orders-table">
                                <tr><td colspan="5" class="empty-state">Select a customer to view orders.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Suppliers Tab -->
            <div class="tab-pane" id="suppliers">
                <div class="panel">
                    <h2>Add Supplier</h2>
                    <form id="add-supplier-form">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="supp-name">Name</label>
                                <input type="text" id="supp-name" placeholder="Supplier name" required>
                            </div>
                            <div class="form-group flex-grow">
                                <label for="supp-email">Contact Email</label>
                                <input type="email" id="supp-email" placeholder="contact@supplier.com">
                            </div>
                            <div class="form-group flex-grow">
                                <label for="supp-phone">Phone</label>
                                <input type="tel" id="supp-phone" placeholder="Phone number">
                            </div>
                            <div class="form-group">
                                <button type="submit">Add Supplier</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <h2>Supplier List</h2>
                    <div id="supplier-list">
                        <div class="empty-state">No suppliers yet.</div>
                    </div>
                </div>
                <div class="panel supplier-products-section" id="supplier-products-panel" style="display: none;">
                    <h2 id="supplier-products-title">Supplier Products</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody id="supplier-products-table">
                                <tr><td colspan="4" class="empty-state">Select a supplier to view products.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div class="tab-pane" id="alerts">
                <div class="panel">
                    <h2>Restock Alerts</h2>
                    <div style="margin-bottom: 1rem;">
                        <select id="alerts-filter" onchange="loadAlerts()" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px;">
                            <option value="">All Alerts</option>
                            <option value="active" selected>Active</option>
                            <option value="ordered">Ordered</option>
                            <option value="dismissed">Dismissed</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Stock</th>
                                    <th>Threshold</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-table">
                                <tr><td colspan="7" class="empty-state">No alerts.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Coupons Tab -->
            <div class="tab-pane" id="coupons">
                <div class="panel">
                    <h2>Create Coupon</h2>
                    <form id="add-coupon-form">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="coupon-code">Code</label>
                                <input type="text" id="coupon-code" placeholder="e.g. SUMMER20"
                                       style="text-transform: uppercase;" required>
                            </div>
                            <div class="form-group">
                                <label for="coupon-type">Type</label>
                                <select id="coupon-type" style="background: var(--bg-card); color: var(--text-primary);
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                        border-radius: 8px; font-size: 1rem;">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed">Fixed ($)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="coupon-value">Value</label>
                                <input type="number" id="coupon-value" step="0.01" min="0.01"
                                       placeholder="10" required>
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 0.75rem;">
                            <div class="form-group">
                                <label for="coupon-min-order">Min Order ($)</label>
                                <input type="number" id="coupon-min-order" step="0.01" min="0"
                                       value="0" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="coupon-max-uses">Max Uses</label>
                                <input type="number" id="coupon-max-uses" min="0" value="0"
                                       placeholder="0 = unlimited">
                            </div>
                            <div class="form-group">
                                <label for="coupon-expires">Expires At</label>
                                <input type="datetime-local" id="coupon-expires"
                                       style="background: var(--bg-card); color: var(--text-primary);
                                       border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                       border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div class="form-group">
                                <button type="submit">Create Coupon</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <h2>Coupon List</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Min Order</th>
                                    <th>Uses</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coupons-table">
                                <tr><td colspan="8" class="empty-state">No coupons yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div class="tab-pane" id="campaigns">
                <div class="panel">
                    <h2>Create Campaign</h2>
                    <form id="add-campaign-form">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="campaign-title">Title</label>
                                <input type="text" id="campaign-title" placeholder="Campaign title" required>
                            </div>
                            <div class="form-group">
                                <label for="campaign-type">Type</label>
                                <select id="campaign-type" onchange="onCampaignTypeChange()"
                                        style="background: var(--bg-card); color: var(--text-primary);
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                        border-radius: 8px; font-size: 1rem;">
                                    <option value="banner">Banner</option>
                                    <option value="discount_promo">Discount Promo</option>
                                    <option value="product_spotlight">Product Spotlight</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 0.75rem;">
                            <div class="form-group flex-grow">
                                <label for="campaign-content">Content</label>
                                <textarea id="campaign-content" rows="2" placeholder="Banner text or promo description"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="campaign-image-url">Image URL</label>
                                <input type="text" id="campaign-image-url" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label for="campaign-link-url">Link URL</label>
                                <input type="text" id="campaign-link-url" placeholder="https://...">
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 0.75rem;">
                            <div class="form-group">
                                <label for="campaign-coupon-code">Coupon Code</label>
                                <input type="text" id="campaign-coupon-code" placeholder="e.g. SUMMER20"
                                       style="text-transform: uppercase;">
                            </div>
                            <div class="form-group" id="campaign-product-group" style="display: none;">
                                <label for="campaign-product-id">Product</label>
                                <select id="campaign-product-id"
                                        style="background: var(--bg-card); color: var(--text-primary);
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                        border-radius: 8px; font-size: 1rem;">
                                    <option value="">-- Select product --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="campaign-priority">Priority</label>
                                <input type="number" id="campaign-priority" min="0" value="0" placeholder="0">
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 0.75rem;">
                            <div class="form-group">
                                <label for="campaign-start-date">Start Date</label>
                                <input type="datetime-local" id="campaign-start-date" required
                                       style="background: var(--bg-card); color: var(--text-primary);
                                       border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                       border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div class="form-group">
                                <label for="campaign-end-date">End Date</label>
                                <input type="datetime-local" id="campaign-end-date" required
                                       style="background: var(--bg-card); color: var(--text-primary);
                                       border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1rem;
                                       border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; padding-top: 1.5rem;">
                                <input type="checkbox" id="campaign-is-active" checked
                                       style="width: auto; accent-color: var(--accent);">
                                <label for="campaign-is-active" style="margin: 0;">Active</label>
                            </div>
                            <div class="form-group">
                                <button type="submit">Create Campaign</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <h2>Campaign List</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Dates</th>
                                    <th>Coupon</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaigns-table">
                                <tr><td colspan="7" class="empty-state">No campaigns yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div class="tab-pane" id="invoices">
                <div class="panel">
                    <h2>Invoice History</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice #</th>
                                    <th>Customer</th>
                                    <th>Order ID</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-table">
                                <tr><td colspan="6" class="empty-state">No invoices yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Settings Tab -->
            <div class="tab-pane" id="settings">
                <div class="panel">
                    <h2>Change Admin Password</h2>
                    <form id="change-password-form">
                        <div class="form-group" style="max-width: 400px;">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" placeholder="Enter current password" required
                                   style="background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; width: 100%;">
                        </div>
                        <div class="form-group" style="max-width: 400px; margin-top: 1rem;">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" placeholder="Enter new password (min 8 chars)" required minlength="8"
                                   style="background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; width: 100%;">
                        </div>
                        <div class="form-group" style="max-width: 400px; margin-top: 1rem;">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password" placeholder="Confirm new password" required minlength="8"
                                   style="background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; width: 100%;">
                        </div>
                        <div id="password-change-msg" style="margin-top: 1rem; display: none;"></div>
                        <div style="margin-top: 1.5rem;">
                            <button type="submit">Change Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="log-panel">
            <h2>Activity Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="custom-modal">
            <h3>Edit Product</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-sku">SKU</label>
                    <input type="text" id="edit-sku" required>
                </div>
                <div class="form-group">
                    <label for="edit-price">Price ($)</label>
                    <input type="number" id="edit-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="edit-stock">Stock</label>
                    <input type="number" id="edit-stock" min="0" required>
                </div>
                <div class="form-group">
                    <label for="edit-reorder">Reorder At</label>
                    <input type="number" id="edit-reorder" min="0" value="10">
                </div>
                <div class="form-group flex-grow">
                    <label for="edit-supplier">Supplier</label>
                    <select id="edit-supplier">
                        <option value="">-- No supplier --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-image">Replace Image</label>
                    <input type="file" id="edit-image" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" rows="3" placeholder="Product description"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attach Order Modal -->
    <div class="modal-overlay" id="attach-modal">
        <div class="custom-modal">
            <h3>Attach Order to Customer</h3>
            <div class="form-group">
                <label for="attach-customer-select">Select Customer</label>
                <select id="attach-customer-select">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeAttachModal()">Cancel</button>
                <button type="button" onclick="confirmAttachOrder()">Attach</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="delete-modal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete product <strong id="delete-product-name"></strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Delete Confirmation Modal -->
    <div class="modal fade" id="delete-order-modal" tabindex="-1" aria-labelledby="deleteOrderModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteOrderModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to permanently delete order <strong id="delete-order-id"></strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-order-btn">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoice-modal">
        <div class="custom-modal" style="max-width: 700px;">
            <div id="invoice-content">
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeInvoiceModal()">Close</button>
                <button type="button" onclick="printInvoice()">Print</button>
            </div>
        </div>
    </div>

    <script>
        let _suppliersCache = [];
        let _ordersCache = [];
        let _unassignedOrdersCache = [];
        let _invoicesCache = [];
        let _productsCache = [];
        let _customersCache = [];
        let _selectedCustomerId = null;
        let _alertsCache = [];
        let _attachOrderId = null;

        // Utility: Log messages
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // API helper with error handling
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(endpoint, options);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: response.statusText }));
                throw new Error(error.detail || 'Request failed');
            }

            if (response.status === 204) return null;
            return response.json();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            // Update search placeholder based on active tab
            const searchEl = document.getElementById('global-search');
            if (searchEl) {
                const placeholders = {
                    dashboard: 'Search...',
                    inventory: 'Search products...',
                    orders: 'Search orders...',
                    customers: 'Search customers...',
                    suppliers: 'Search suppliers...',
                    alerts: 'Search alerts...',
                    coupons: 'Search coupons...',
                    campaigns: 'Search campaigns...',
                    invoices: 'Search invoices...',
                    settings: 'Search...'
                };
                searchEl.placeholder = placeholders[tabName] || 'Search...';
            }
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'orders') loadOrders();
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'suppliers') loadSuppliers();
            if (tabName === 'alerts') loadAlerts();
            if (tabName === 'coupons') loadCoupons();
            if (tabName === 'campaigns') loadCampaigns();
            if (tabName === 'invoices') loadInvoices();
            applySearch();
        }

        // ---- Product / Inventory Logic ----

        async function loadProducts() {
            try {
                const products = await apiCall('/products');
                _productsCache = products || [];
                renderInventory(_productsCache);
                applySearch();
            } catch (error) {
                log(`Failed to load products: ${error.message}`, 'error');
            }
        }

        async function createProduct(data) {
            try {
                const product = await apiCall('/products', 'POST', data);
                log(`Created product: ${product.name}`, 'success');
                loadProducts();
            } catch (error) {
                log(`Failed to create product: ${error.message}`, 'error');
            }
        }

        async function deleteProduct(id, name) {
            try {
                await apiCall(`/products/${id}`, 'DELETE');
                log(`Deleted product: ${name}`, 'success');
                loadProducts();
            } catch (error) {
                log(`Failed to delete product: ${error.message}`, 'error');
            }
        }

        function openDeleteModal(id, name) {
            document.getElementById('delete-product-name').textContent = name;
            const deleteModal = new bootstrap.Modal(document.getElementById('delete-modal'));
            document.getElementById('confirm-delete-btn').onclick = () => {
                deleteProduct(id, name);
                deleteModal.hide();
            };
            deleteModal.show();
        }

        function renderInventory(products) {
            const tbody = document.getElementById('product-table');

            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No products yet. Add one above!</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => {
                const stockClass = p.stock === 0 ? 'out' : p.stock < 10 ? 'low' : '';
                const imageHtml = p.image_data
                    ? `<img src="${p.image_data}" alt="${escapeHtml(p.name)}" width="50" height="50" style="object-fit: cover;">`
                    : `<div style="width: 50px; height: 50px; background: #ccc; display: inline-block;"></div>`;
                const desc = escapeHtml(p.description || '');
                const supplier = _suppliersCache.find(s => s.id === p.supplier_id);
                const supplierName = supplier ? escapeHtml(supplier.name) : '-';
                const supplierClass = (supplier && p.stock <= (p.reorder_threshold ?? 10)) ? 'supplier-reorder' : '';

                return `
                    <tr data-id="${p.id}">
                        <td>${imageHtml}</td>
                        <td>${escapeHtml(p.name)}</td>
                        <td>${escapeHtml(p.sku)}</td>
                        <td class="price">$${p.price.toFixed(2)}</td>
                        <td class="stock ${stockClass}">${p.stock}</td>
                        <td><span class="${supplierClass}">${supplierName}</span></td>
                        <td class="desc-cell" title="${desc}">${desc}</td>
                        <td class="actions">
                            <button class="small secondary" onclick="openEditModal('${p.id}')">Edit</button>
                            <button class="small danger" onclick="openDeleteModal('${p.id}', '${escapeHtml(p.name)}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Edit modal functions
        function openEditModal(id) {
            const p = _productsCache.find(prod => prod.id === id);
            if (!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-sku').value = p.sku;
            document.getElementById('edit-price').value = p.price;
            document.getElementById('edit-stock').value = p.stock;
            document.getElementById('edit-reorder').value = p.reorder_threshold ?? 10;
            document.getElementById('edit-supplier').value = p.supplier_id || '';
            document.getElementById('edit-description').value = p.description || '';
            document.getElementById('edit-image').value = '';
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Form handlers
        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('add-name').value.trim();
            const sku = document.getElementById('add-sku').value.trim();
            const price = parseFloat(document.getElementById('add-price').value) || 0;
            const stock = parseInt(document.getElementById('add-stock').value) || 0;
            const reorder_threshold = parseInt(document.getElementById('add-reorder').value) || 0;
            const supplier_id = document.getElementById('add-supplier').value || null;
            const description = document.getElementById('add-description').value.trim();
            const imageFile = document.getElementById('add-image').files[0];

            if (!name || !sku) {
                log('Product name and SKU are required', 'error');
                return;
            }

            let imageData = null;
            if (imageFile) {
                if (imageFile.size > 1024 * 1024) {
                    log('Image file size must be under 1MB', 'error');
                    return;
                }
                imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
            }

            await createProduct({ name, sku, price, stock, image_data: imageData, description, reorder_threshold, supplier_id });
            document.getElementById('add-form').reset();
        });

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value.trim();
            const sku = document.getElementById('edit-sku').value.trim();
            const price = parseFloat(document.getElementById('edit-price').value) || 0;
            const stock = parseInt(document.getElementById('edit-stock').value) || 0;
            const reorder_threshold = parseInt(document.getElementById('edit-reorder').value) || 0;
            const supplier_id = document.getElementById('edit-supplier').value || null;
            const description = document.getElementById('edit-description').value.trim();
            const imageFile = document.getElementById('edit-image').files[0];

            if (!name || !sku) {
                log('Product name and SKU are required', 'error');
                return;
            }

            let imageData = null;
            if (imageFile) {
                if (imageFile.size > 1024 * 1024) {
                    log('Image file size must be under 1MB', 'error');
                    return;
                }
                imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
            }

            try {
                const product = await apiCall(`/products/${id}`, 'PUT', { name, sku, price, stock, image_data: imageData, description, reorder_threshold, supplier_id });
                log(`Updated product: ${product.name}`, 'success');
                loadProducts();
            } catch (error) {
                log(`Failed to update product: ${error.message}`, 'error');
            }

            closeEditModal();
        });

        // Close modal on overlay click
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') {
                closeEditModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                closeInvoiceModal();
            }
        });

        // ---- Order Logic ----

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const order = await apiCall(`/orders/${orderId}/status`, 'PATCH', { status: newStatus });
                log(`Order ${orderId.substring(0, 8)}... status changed to "${order.status}"`, 'success');
                loadOrders();
                if (_selectedCustomerId) loadCustomerOrders(_selectedCustomerId);
            } catch (error) {
                log(`Failed to update order status: ${error.message}`, 'error');
            }
        }

        function getNextStatuses(currentStatus) {
            const transitions = {
                'pending': ['processing', 'cancelled'],
                'processing': ['shipped', 'cancelled'],
                'shipped': ['delivered', 'cancelled'],
                'delivered': ['returned'],
                'cancelled': [],
                'returned': []
            };
            return transitions[currentStatus] || ['processing', 'cancelled'];
        }

        function renderStatusBadge(status) {
            return `<span class="status-badge status-${escapeHtml(status)}">${escapeHtml(status)}</span>`;
        }

        function renderStatusActions(orderId, currentStatus) {
            const nextStatuses = getNextStatuses(currentStatus);
            if (nextStatuses.length === 0) {
                return '<button class="small" disabled style="opacity:0.4;cursor:not-allowed;">No Actions</button>';
            }

            const forward = nextStatuses.filter(s => s !== 'cancelled');
            const canCancel = nextStatuses.includes('cancelled');
            let html = '';

            if (forward.length > 0) {
                const next = forward[0];
                html += `<button class="small secondary" onclick="updateOrderStatus('${orderId}', '${next}')">${next.charAt(0).toUpperCase() + next.slice(1)}</button>`;
            }
            if (canCancel) {
                html += ` <button class="small danger" onclick="updateOrderStatus('${orderId}', 'cancelled')">Cancel</button>`;
            }
            return html;
        }

        function renderInvoiceActions(order) {
            if (order.status !== 'delivered' && order.status !== 'returned') {
                return '';
            }
            if (order.invoice_id) {
                return `<button class="small secondary" onclick="viewInvoice('${order.invoice_id}')">View Invoice</button>`;
            }
            return `<button class="small secondary" onclick="generateInvoice('${order.id}')">Generate Invoice</button>`;
        }

        async function generateInvoice(orderId) {
            try {
                const invoice = await apiCall(`/orders/${orderId}/invoice`, 'POST');
                log(`Invoice INV-${String(invoice.invoice_number).padStart(4, '0')} generated`, 'success');
                loadOrders();
            } catch (error) {
                log(`Failed to generate invoice: ${error.message}`, 'error');
            }
        }

        function toggleOrderDetail(orderId) {
            const detailRow = document.getElementById('order-detail-' + orderId);
            if (detailRow) {
                detailRow.classList.toggle('expanded');
            }
        }

        function renderOrderDetail(order) {
            const customerName = order.customer_name
                ? escapeHtml(order.customer_name)
                : (order.customer_id ? 'Unknown customer' : 'No customer');

            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                const rows = order.items.map(item => {
                    const name = item.product_name ? escapeHtml(item.product_name) : 'Unknown product';
                    const lineTotal = (item.quantity * item.price_at_purchase).toFixed(2);
                    return `<tr>
                        <td>${name}</td>
                        <td>${item.quantity}</td>
                        <td class="price">$${item.price_at_purchase.toFixed(2)}</td>
                        <td class="price">$${lineTotal}</td>
                    </tr>`;
                }).join('');
                itemsHtml = `<table class="line-items-table">
                    <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>`;
            } else {
                itemsHtml = '<span style="color:var(--text-secondary)">No line items</span>';
            }

            let discountHtml = '';
            if (order.coupon_code && order.discount_amount > 0) {
                const subtotal = order.total_amount + order.discount_amount;
                discountHtml = `
                    <div class="discount-section">
                        <h4>Coupon Applied</h4>
                        <p>Code: <strong>${escapeHtml(order.coupon_code)}</strong></p>
                        <p>Subtotal: $${subtotal.toFixed(2)}</p>
                        <p class="discount-line">Discount: -$${order.discount_amount.toFixed(2)}</p>
                        <p>Final Total: <strong class="price">$${order.total_amount.toFixed(2)}</strong></p>
                    </div>`;
            }

            return `<td colspan="5" style="padding:0;">
                <div style="padding: 0.75rem 1rem 1rem;">
                    <div class="order-detail-content">
                        <div>
                            <h4>Line Items</h4>
                            ${itemsHtml}
                        </div>
                        <div>
                            <h4>Customer</h4>
                            <p>${customerName}</p>
                            ${discountHtml}
                        </div>
                    </div>
                </div>
            </td>`;
        }

        function renderOrdersFromCache(orders, unassigned) {
            const tbody = document.getElementById('orders-table');
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No orders yet.</td></tr>';
            } else {
                tbody.innerHTML = orders.map(o => {
                    const date = o.created_at ? new Date(o.created_at).toLocaleString() : 'N/A';
                    const shortId = o.id.substring(0, 8);
                    return `
                        <tr class="order-row" onclick="toggleOrderDetail('${o.id}')">
                            <td>${date}</td>
                            <td title="${o.id}">${shortId}...</td>
                            <td class="price">$${o.total_amount.toFixed(2)}</td>
                            <td>${renderStatusBadge(o.status)}</td>
                            <td class="actions" onclick="event.stopPropagation()">${renderStatusActions(o.id, o.status)} ${renderInvoiceActions(o)}</td>
                        </tr>
                        <tr class="order-detail-row" id="order-detail-${o.id}">
                            ${renderOrderDetail(o)}
                        </tr>
                    `;
                }).join('');
            }

            const unassignedTbody = document.getElementById('unassigned-orders-table');
            if (!unassigned || unassigned.length === 0) {
                unassignedTbody.innerHTML = '<tr><td colspan="5" class="empty-state">No unassigned orders.</td></tr>';
            } else {
                unassignedTbody.innerHTML = unassigned.map(o => {
                    const date = o.created_at ? new Date(o.created_at).toLocaleString() : 'N/A';
                    const shortId = o.id.substring(0, 8);
                    return `
                        <tr class="order-row" onclick="toggleOrderDetail('${o.id}')">
                            <td>${date}</td>
                            <td title="${o.id}">${shortId}...</td>
                            <td class="price">$${o.total_amount.toFixed(2)}</td>
                            <td>${renderStatusBadge(o.status)}</td>
                            <td class="actions" onclick="event.stopPropagation()">
                                ${renderStatusActions(o.id, o.status)}
                                <button class="small secondary" onclick="openAttachModal('${o.id}')">Attach</button>
                                <button class="small danger" onclick="openDeleteOrderModal('${o.id}')">Delete</button>
                            </td>
                        </tr>
                        <tr class="order-detail-row" id="order-detail-${o.id}">
                            ${renderOrderDetail(o)}
                        </tr>
                    `;
                }).join('');
            }
        }

        async function loadOrders() {
            try {
                const orders = await apiCall('/orders');
                _ordersCache = orders || [];
            } catch (error) {
                log(`Failed to load orders: ${error.message}`, 'error');
                _ordersCache = [];
            }

            try {
                const unassigned = await apiCall('/orders/unassigned');
                _unassignedOrdersCache = unassigned || [];
            } catch (error) {
                log(`Failed to load unassigned orders: ${error.message}`, 'error');
                _unassignedOrdersCache = [];
            }

            applySearch();
        }

        function openDeleteOrderModal(orderId) {
            const shortId = orderId.substring(0, 8) + '...';
            document.getElementById('delete-order-id').textContent = shortId;
            const deleteOrderModal = new bootstrap.Modal(document.getElementById('delete-order-modal'));
            document.getElementById('confirm-delete-order-btn').onclick = () => {
                deleteOrder(orderId);
                deleteOrderModal.hide();
            };
            deleteOrderModal.show();
        }

        async function deleteOrder(orderId) {
            try {
                await apiCall(`/orders/${orderId}`, 'DELETE');
                log(`Deleted order ${orderId.substring(0, 8)}...`, 'success');
                loadOrders();
            } catch (error) {
                log(`Failed to delete order: ${error.message}`, 'error');
            }
        }

        async function openAttachModal(orderId) {
            _attachOrderId = orderId;
            const select = document.getElementById('attach-customer-select');
            select.innerHTML = '<option value="">-- Loading customers... --</option>';
            document.getElementById('attach-modal').classList.add('active');
            try {
                const customers = await apiCall('/customers');
                _customersCache = customers || [];
            } catch (e) {
                log('Failed to load customers for modal', 'error');
            }
            select.innerHTML = '<option value="">-- Select Customer --</option>';
            _customersCache.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = `${c.name} (${c.email})`;
                select.appendChild(option);
            });
        }

        function closeAttachModal() {
            document.getElementById('attach-modal').classList.remove('active');
            _attachOrderId = null;
        }

        async function confirmAttachOrder() {
            const customerId = document.getElementById('attach-customer-select').value;
            if (!customerId) {
                log('Please select a customer', 'error');
                return;
            }

            try {
                await apiCall(`/orders/${_attachOrderId}/customer/${customerId}`, 'PUT');
                log(`Order ${_attachOrderId.substring(0, 8)}... attached to customer`, 'success');
                closeAttachModal();
                loadOrders();
            } catch (error) {
                log(`Failed to attach order: ${error.message}`, 'error');
            }
        }

        // Close attach modal on overlay click
        document.getElementById('attach-modal').addEventListener('click', (e) => {
            if (e.target.id === 'attach-modal') {
                closeAttachModal();
            }
        });

        // ---- Customer Logic ----

        async function loadCustomers() {
            try {
                const customers = await apiCall('/customers');
                _customersCache = customers || [];
                applySearch();
            } catch (error) {
                log(`Failed to load customers: ${error.message}`, 'error');
            }
        }

        function renderCustomerList(customers) {
            const container = document.getElementById('customer-list');
            if (!customers || customers.length === 0) {
                container.innerHTML = '<div class="empty-state">No customers yet. Add one above!</div>';
                document.getElementById('customer-orders-panel').style.display = 'none';
                document.getElementById('customer-detail-panel').style.display = 'none';
                return;
            }

            container.innerHTML = customers.map(c => {
                const date = c.created_at ? new Date(c.created_at).toLocaleDateString() : 'N/A';
                const selectedClass = _selectedCustomerId === c.id ? 'selected' : '';
                const companyHtml = c.company ? `<span style="color: var(--text-secondary); margin-left: 0.5rem;">(${escapeHtml(c.company)})</span>` : '';
                let addrParts = [];
                if (c.shipping_city) addrParts.push(c.shipping_city);
                if (c.shipping_state) addrParts.push(c.shipping_state);
                if (c.shipping_country) addrParts.push(c.shipping_country);
                const addrHtml = addrParts.length > 0
                    ? `<div style="color: var(--text-secondary); font-size: 0.8rem;">${escapeHtml(addrParts.join(', '))}</div>`
                    : '';
                return `
                    <div class="customer-list-item ${selectedClass}" onclick="selectCustomer('${c.id}')">
                        <div>
                            <strong>${escapeHtml(c.name)}</strong>${companyHtml}
                            <span style="color: var(--text-secondary); margin-left: 0.5rem;">${escapeHtml(c.email)}</span>
                            ${addrHtml}
                        </div>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">${date}</span>
                    </div>
                `;
            }).join('');
        }

        async function selectCustomer(customerId) {
            _selectedCustomerId = customerId;
            applySearch();
            document.getElementById('customer-orders-panel').style.display = 'block';
            const customer = _customersCache.find(c => c.id === customerId);
            document.getElementById('customer-orders-title').textContent =
                customer ? `Orders for ${customer.name}` : 'Customer Orders';

            // Show customer detail panel
            if (customer) {
                const detailPanel = document.getElementById('customer-detail-panel');
                detailPanel.style.display = 'block';
                document.getElementById('customer-detail-title').textContent = `Details for ${customer.name}`;
                let detailHtml = `<p><strong>Email:</strong> ${escapeHtml(customer.email)}</p>`;
                if (customer.company) detailHtml += `<p><strong>Company:</strong> ${escapeHtml(customer.company)}</p>`;
                if (customer.phone) detailHtml += `<p><strong>Phone:</strong> ${escapeHtml(customer.phone)}</p>`;
                let addrParts = [];
                if (customer.shipping_street) addrParts.push(customer.shipping_street);
                if (customer.shipping_city) addrParts.push(customer.shipping_city);
                if (customer.shipping_state) addrParts.push(customer.shipping_state);
                if (customer.shipping_zip) addrParts.push(customer.shipping_zip);
                if (customer.shipping_country) addrParts.push(customer.shipping_country);
                if (addrParts.length > 0) {
                    detailHtml += `<p><strong>Shipping Address:</strong> ${escapeHtml(addrParts.join(', '))}</p>`;
                }
                document.getElementById('customer-detail-content').innerHTML = detailHtml;
            }

            await loadCustomerOrders(customerId);
        }

        async function loadCustomerOrders(customerId) {
            const tbody = document.getElementById('customer-orders-table');
            try {
                const orders = await apiCall(`/customers/${customerId}/orders`);
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No orders for this customer.</td></tr>';
                    return;
                }
                tbody.innerHTML = orders.map(o => {
                    const date = o.created_at ? new Date(o.created_at).toLocaleString() : 'N/A';
                    const shortId = o.id.substring(0, 8);
                    return `
                        <tr>
                            <td>${date}</td>
                            <td title="${o.id}">${shortId}...</td>
                            <td class="price">$${o.total_amount.toFixed(2)}</td>
                            <td>${renderStatusBadge(o.status)}</td>
                            <td class="actions">
                                ${renderStatusActions(o.id, o.status)}
                                <button class="small danger" onclick="detachOrder('${customerId}', '${o.id}')">Detach</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                log(`Failed to load customer orders: ${error.message}`, 'error');
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load orders.</td></tr>';
            }
        }

        async function detachOrder(customerId, orderId) {
            try {
                await apiCall(`/customers/${customerId}/orders/${orderId}`, 'DELETE');
                log(`Order ${orderId.substring(0, 8)}... detached from customer`, 'success');
                await loadCustomerOrders(customerId);
            } catch (error) {
                log(`Failed to detach order: ${error.message}`, 'error');
            }
        }

        document.getElementById('add-customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('cust-name').value.trim();
            const email = document.getElementById('cust-email').value.trim();
            if (!name || !email) {
                log('Customer name and email are required', 'error');
                return;
            }
            const payload = { name, email };
            const company = document.getElementById('cust-company').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const street = document.getElementById('cust-street').value.trim();
            const city = document.getElementById('cust-city').value.trim();
            const state = document.getElementById('cust-state').value.trim();
            const zip = document.getElementById('cust-zip').value.trim();
            const country = document.getElementById('cust-country').value.trim();
            if (company) payload.company = company;
            if (phone) payload.phone = phone;
            if (street) payload.shipping_street = street;
            if (city) payload.shipping_city = city;
            if (state) payload.shipping_state = state;
            if (zip) payload.shipping_zip = zip;
            if (country) payload.shipping_country = country;
            try {
                const customer = await apiCall('/customers', 'POST', payload);
                log(`Created customer: ${customer.name}`, 'success');
                document.getElementById('add-customer-form').reset();
                await loadCustomers();
            } catch (error) {
                log(`Failed to create customer: ${error.message}`, 'error');
            }
        });

        // ---- Supplier Logic ----

        async function loadSuppliers() {
            try {
                const suppliers = await apiCall('/suppliers');
                _suppliersCache = suppliers || [];
                loadSupplierDropdowns();
                applySearch();
            } catch (error) {
                log(`Failed to load suppliers: ${error.message}`, 'error');
            }
        }

        function renderSupplierList(suppliers) {
            suppliers = suppliers || _suppliersCache;
            const list = document.getElementById('supplier-list');
            if (!suppliers.length) {
                list.innerHTML = '<div class="empty-state">No suppliers yet.</div>';
                return;
            }
            list.innerHTML = suppliers.map(s => {
                const lowBadge = s.low_stock_count > 0
                    ? `<span class="supplier-reorder" style="margin-left:0.5rem;">${s.low_stock_count} low stock</span>`
                    : '';
                return `
                <div class="customer-list-item" onclick="selectSupplier('${s.id}')">
                    <div>
                        <strong>${escapeHtml(s.name)}</strong>
                        <span style="color: var(--text-secondary); margin-left: 0.5rem;">${escapeHtml(s.contact_email || '')} ${escapeHtml(s.phone || '')}</span>
                        ${lowBadge}
                    </div>
                    <div class="actions">
                        <button class="small secondary" onclick="event.stopPropagation(); selectSupplier('${s.id}')">Products</button>
                        <button class="small danger" onclick="event.stopPropagation(); deleteSupplier('${s.id}', '${escapeHtml(s.name).replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function selectSupplier(id) {
            try {
                const products = await apiCall(`/suppliers/${id}/products`);
                const title = document.getElementById('supplier-products-title');
                const supplier = _suppliersCache.find(s => s.id === id);
                title.textContent = `Products for ${supplier.name}`;

                const tbody = document.getElementById('supplier-products-table');
                if (!products.length) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No products attached to this supplier.</td></tr>';
                } else {
                    tbody.innerHTML = products.map(p => `
                        <tr>
                            <td>${escapeHtml(p.name)}</td>
                            <td>${escapeHtml(p.sku)}</td>
                            <td>$${p.price.toFixed(2)}</td>
                            <td class="stock ${p.stock <= p.reorder_threshold ? 'out' : ''}">${p.stock}</td>
                        </tr>
                    `).join('');
                }
                document.getElementById('supplier-products-panel').style.display = 'block';
            } catch (error) {
                log(`Failed to load supplier products: ${error.message}`, 'error');
            }
        }

        document.getElementById('add-supplier-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('supp-name').value;
            const email = document.getElementById('supp-email').value;
            const phone = document.getElementById('supp-phone').value;
            try {
                await apiCall('/suppliers', 'POST', { name, contact_email: email, phone });
                log(`Added supplier: ${name}`, 'success');
                e.target.reset();
                loadSuppliers();
            } catch (error) {
                log(`Failed to add supplier: ${error.message}`, 'error');
            }
        });

        async function deleteSupplier(id, name) {
            if (!confirm(`Are you sure you want to delete supplier ${name}?`)) return;
            try {
                await apiCall(`/suppliers/${id}`, 'DELETE');
                log(`Deleted supplier: ${name}`, 'success');
                if (document.getElementById('supplier-products-panel').style.display === 'block') {
                    document.getElementById('supplier-products-panel').style.display = 'none';
                }
                loadSuppliers();
            } catch (error) {
                log(`Failed to delete supplier: ${error.message}`, 'error');
            }
        }

        function loadSupplierDropdowns() {
            const addSelect = document.getElementById('add-supplier');
            const editSelect = document.getElementById('edit-supplier');
            const options = '<option value="">-- No supplier --</option>' + _suppliersCache.map(s =>
                `<option value="${s.id}">${escapeHtml(s.name)}</option>`
            ).join('');
            if (addSelect) addSelect.innerHTML = options;
            if (editSelect) editSelect.innerHTML = options;
        }

        // ---- Dashboard Logic ----

        async function loadDashboard() {
            try {
                const data = await apiCall('/dashboard');
                // Revenue
                document.getElementById('dashboard-revenue').textContent =
                    '$' + data.total_revenue.toFixed(2);

                // Orders by status
                const statusContainer = document.getElementById('dashboard-orders-status');
                const statuses = data.orders_by_status;
                if (Object.keys(statuses).length === 0) {
                    statusContainer.innerHTML = '<span class="empty-state">No orders yet.</span>';
                } else {
                    statusContainer.innerHTML = Object.entries(statuses).map(([status, count]) =>
                        `<span class="status-badge status-${escapeHtml(status)}" style="margin: 0.25rem;">${escapeHtml(status)}: ${count}</span>`
                    ).join(' ');
                }

                // Top products
                const topTbody = document.getElementById('dashboard-top-products');
                if (!data.top_products || data.top_products.length === 0) {
                    topTbody.innerHTML = '<tr><td colspan="3" class="empty-state">No sales data yet.</td></tr>';
                } else {
                    topTbody.innerHTML = data.top_products.map((p, i) =>
                        `<tr><td>${i + 1}</td><td>${escapeHtml(p.name)}</td><td>${p.total_sold}</td></tr>`
                    ).join('');
                }

                // Low stock alerts
                const lowTbody = document.getElementById('dashboard-low-stock');
                if (!data.low_stock_alerts || data.low_stock_alerts.length === 0) {
                    lowTbody.innerHTML = '<tr><td colspan="5" class="empty-state">No low-stock items.</td></tr>';
                } else {
                    lowTbody.innerHTML = data.low_stock_alerts.map(item => {
                        const supplierName = item.supplier ? escapeHtml(item.supplier.name) : '-';
                        const supplierEmail = item.supplier && item.supplier.contact_email
                            ? escapeHtml(item.supplier.contact_email) : '-';
                        const stockClass = item.stock === 0 ? 'out' : 'low';
                        return `<tr>
                            <td>${escapeHtml(item.name)}</td>
                            <td class="stock ${stockClass}">${item.stock}</td>
                            <td>${item.reorder_threshold}</td>
                            <td>${supplierName}</td>
                            <td>${supplierEmail}</td>
                        </tr>`;
                    }).join('');
                }
            } catch (error) {
                log('Failed to load dashboard: ' + error.message, 'error');
            }
        }

        // ---- Alerts Logic ----

        async function loadAlerts() {
            try {
                const filter = document.getElementById('alerts-filter')?.value || '';
                const url = filter ? `/alerts?status=${filter}` : '/alerts';
                const alerts = await apiCall(url);
                _alertsCache = alerts || [];
                renderAlerts(_alertsCache);
                updateAlertsBadge();
            } catch (error) {
                log('Failed to load alerts: ' + error.message, 'error');
            }
        }

        async function updateAlertsBadge() {
            try {
                const active = await apiCall('/alerts?status=active');
                const badge = document.getElementById('alerts-badge');
                const count = active ? active.length : 0;
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                // Silent fail for badge update
            }
        }

        function renderAlerts(alerts) {
            const tbody = document.getElementById('alerts-table');
            if (!alerts || alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No alerts.</td></tr>';
                return;
            }
            tbody.innerHTML = alerts.map(a => {
                const productName = a.message.match(/Restock needed: '([^']+)'/)?.[1] || '-';
                const supplierMatch = a.message.match(/Supplier: ([^.]+)/);
                const supplierName = supplierMatch ? supplierMatch[1] : '-';
                const date = a.created_at ? new Date(a.created_at).toLocaleString() : 'N/A';
                const statusClass = a.status === 'active' ? 'low' : a.status === 'ordered' ? '' : '';
                const statusBadge = `<span class="status-badge status-${a.status === 'active' ? 'pending' : a.status === 'ordered' ? 'processing' : 'delivered'}">${escapeHtml(a.status)}</span>`;

                let actions = '';
                if (a.status === 'active') {
                    actions = `<button class="small" onclick="markAlertOrdered('${a.id}')">Mark as Ordered</button>
                               <button class="small secondary" onclick="dismissAlert('${a.id}')">Dismiss</button>`;
                } else if (a.status === 'ordered') {
                    actions = `<button class="small secondary" onclick="dismissAlert('${a.id}')">Dismiss</button>`;
                } else {
                    actions = '<span style="color: var(--text-secondary);">-</span>';
                }

                return `<tr>
                    <td>${escapeHtml(productName)}</td>
                    <td class="stock ${statusClass}">${a.current_stock != null ? a.current_stock : '-'}</td>
                    <td>${a.reorder_threshold != null ? a.reorder_threshold : '-'}</td>
                    <td>${escapeHtml(supplierName)}</td>
                    <td>${statusBadge}</td>
                    <td>${date}</td>
                    <td class="actions">${actions}</td>
                </tr>`;
            }).join('');
        }

        async function markAlertOrdered(alertId) {
            try {
                await apiCall(`/alerts/${alertId}`, 'PATCH', { status: 'ordered' });
                log('Alert marked as ordered', 'success');
                await loadAlerts();
            } catch (error) {
                log('Failed to update alert: ' + error.message, 'error');
            }
        }

        async function dismissAlert(alertId) {
            try {
                await apiCall(`/alerts/${alertId}`, 'PATCH', { status: 'dismissed' });
                log('Alert dismissed', 'success');
                await loadAlerts();
            } catch (error) {
                log('Failed to dismiss alert: ' + error.message, 'error');
            }
        }

        // ---- Coupon Management ----

        async function loadCoupons() {
            try {
                const coupons = await apiCall('/coupons');
                const tbody = document.getElementById('coupons-table');
                if (!coupons.length) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No coupons yet.</td></tr>';
                    return;
                }
                tbody.innerHTML = coupons.map(c => {
                    const isExpired = c.expires_at && new Date(c.expires_at) < new Date();
                    const usageLimitReached = c.max_uses > 0 && c.current_uses >= c.max_uses;
                    let statusText = 'Active';
                    let statusClass = 'status-delivered';
                    if (!c.is_active) { statusText = 'Inactive'; statusClass = 'status-cancelled'; }
                    else if (isExpired) { statusText = 'Expired'; statusClass = 'status-cancelled'; }
                    else if (usageLimitReached) { statusText = 'Exhausted'; statusClass = 'status-returned'; }

                    const usageDisplay = c.max_uses > 0
                        ? `${c.current_uses} / ${c.max_uses}`
                        : `${c.current_uses} / \u221e`;
                    const expiresDisplay = c.expires_at
                        ? new Date(c.expires_at).toLocaleDateString()
                        : 'Never';
                    const valueDisplay = c.discount_type === 'percentage'
                        ? `${c.discount_value}%`
                        : `$${c.discount_value.toFixed(2)}`;

                    return `<tr>
                        <td><strong>${escapeHtml(c.code)}</strong></td>
                        <td>${c.discount_type}</td>
                        <td>${valueDisplay}</td>
                        <td>$${c.min_order_amount.toFixed(2)}</td>
                        <td>${usageDisplay}</td>
                        <td>${expiresDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="small ${c.is_active ? 'secondary' : ''}"
                                    onclick="toggleCouponActive('${c.id}', ${!c.is_active})">
                                ${c.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="small danger" onclick="deleteCoupon('${c.id}', '${escapeHtml(c.code)}')">
                                Delete
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (error) {
                log('Failed to load coupons: ' + error.message, 'error');
            }
        }

        async function createCoupon(event) {
            event.preventDefault();
            const code = document.getElementById('coupon-code').value.trim();
            const discount_type = document.getElementById('coupon-type').value;
            const discount_value = parseFloat(document.getElementById('coupon-value').value);
            const min_order_amount = parseFloat(document.getElementById('coupon-min-order').value) || 0;
            const max_uses = parseInt(document.getElementById('coupon-max-uses').value) || 0;
            const expiresInput = document.getElementById('coupon-expires').value;
            const expires_at = expiresInput ? new Date(expiresInput).toISOString() : null;

            try {
                await apiCall('/coupons', 'POST', {
                    code, discount_type, discount_value, min_order_amount, max_uses, expires_at
                });
                log(`Coupon "${code.toUpperCase()}" created`, 'success');
                document.getElementById('add-coupon-form').reset();
                loadCoupons();
            } catch (error) {
                log('Failed to create coupon: ' + error.message, 'error');
            }
        }

        async function toggleCouponActive(couponId, newState) {
            try {
                await apiCall(`/coupons/${couponId}`, 'PATCH', { is_active: newState });
                log(`Coupon ${newState ? 'activated' : 'deactivated'}`, 'success');
                loadCoupons();
            } catch (error) {
                log('Failed to update coupon: ' + error.message, 'error');
            }
        }

        async function deleteCoupon(couponId, code) {
            if (!confirm(`Delete coupon "${code}"? This cannot be undone.`)) return;
            try {
                await apiCall(`/coupons/${couponId}`, 'DELETE');
                log(`Coupon "${code}" deleted`, 'success');
                loadCoupons();
            } catch (error) {
                log('Failed to delete coupon: ' + error.message, 'error');
            }
        }

        document.getElementById('add-coupon-form').addEventListener('submit', createCoupon);

        // ---- Campaign Management ----

        function onCampaignTypeChange() {
            const type = document.getElementById('campaign-type').value;
            const productGroup = document.getElementById('campaign-product-group');
            if (type === 'product_spotlight') {
                productGroup.style.display = '';
                loadCampaignProducts();
            } else {
                productGroup.style.display = 'none';
            }
        }

        async function loadCampaignProducts() {
            try {
                const products = await apiCall('/products');
                const select = document.getElementById('campaign-product-id');
                select.innerHTML = '<option value="">-- Select product --</option>' +
                    products.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            } catch (error) {
                log('Failed to load products for campaign: ' + error.message, 'error');
            }
        }

        async function loadCampaigns() {
            try {
                const campaigns = await apiCall('/campaigns');
                const tbody = document.getElementById('campaigns-table');
                if (!campaigns.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No campaigns yet.</td></tr>';
                    return;
                }
                tbody.innerHTML = campaigns.map(c => {
                    const now = new Date();
                    const startDate = new Date(c.start_date);
                    const endDate = new Date(c.end_date);

                    let statusText = 'Active';
                    let statusClass = 'status-delivered';
                    if (!c.is_active) { statusText = 'Inactive'; statusClass = 'status-cancelled'; }
                    else if (endDate < now) { statusText = 'Ended'; statusClass = 'status-returned'; }
                    else if (startDate > now) { statusText = 'Scheduled'; statusClass = 'status-processing'; }

                    const typeLabels = { banner: 'Banner', discount_promo: 'Discount Promo', product_spotlight: 'Spotlight' };
                    const dateRange = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
                    const couponDisplay = c.coupon_code ? escapeHtml(c.coupon_code) : '-';

                    return `<tr>
                        <td><strong>${escapeHtml(c.title)}</strong></td>
                        <td>${typeLabels[c.type] || c.type}</td>
                        <td>${dateRange}</td>
                        <td>${couponDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${c.priority}</td>
                        <td>
                            <button class="small ${c.is_active ? 'secondary' : ''}"
                                    onclick="toggleCampaignActive('${c.id}', ${!c.is_active})">
                                ${c.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="small danger" onclick="deleteCampaign('${c.id}', '${escapeHtml(c.title).replace(/'/g, "\\'")}')">
                                Delete
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (error) {
                log('Failed to load campaigns: ' + error.message, 'error');
            }
        }

        async function createCampaign(event) {
            event.preventDefault();
            const title = document.getElementById('campaign-title').value.trim();
            const type = document.getElementById('campaign-type').value;
            const content = document.getElementById('campaign-content').value.trim();
            const image_url = document.getElementById('campaign-image-url').value.trim() || null;
            const link_url = document.getElementById('campaign-link-url').value.trim() || null;
            const coupon_code = document.getElementById('campaign-coupon-code').value.trim().toUpperCase() || null;
            const product_id = type === 'product_spotlight'
                ? document.getElementById('campaign-product-id').value || null
                : null;
            const priority = parseInt(document.getElementById('campaign-priority').value) || 0;
            const startInput = document.getElementById('campaign-start-date').value;
            const endInput = document.getElementById('campaign-end-date').value;
            const is_active = document.getElementById('campaign-is-active').checked;

            const start_date = startInput ? new Date(startInput).toISOString() : null;
            const end_date = endInput ? new Date(endInput).toISOString() : null;

            try {
                await apiCall('/campaigns', 'POST', {
                    title, type, content, image_url, link_url, coupon_code,
                    product_id, start_date, end_date, is_active, priority
                });
                log(`Campaign "${title}" created`, 'success');
                document.getElementById('add-campaign-form').reset();
                document.getElementById('campaign-product-group').style.display = 'none';
                loadCampaigns();
            } catch (error) {
                log('Failed to create campaign: ' + error.message, 'error');
            }
        }

        async function toggleCampaignActive(campaignId, newState) {
            try {
                await apiCall(`/campaigns/${campaignId}`, 'PATCH', { is_active: newState });
                log(`Campaign ${newState ? 'activated' : 'deactivated'}`, 'success');
                loadCampaigns();
            } catch (error) {
                log('Failed to update campaign: ' + error.message, 'error');
            }
        }

        async function deleteCampaign(campaignId, title) {
            if (!confirm(`Delete campaign "${title}"? This cannot be undone.`)) return;
            try {
                await apiCall(`/campaigns/${campaignId}`, 'DELETE');
                log(`Campaign "${title}" deleted`, 'success');
                loadCampaigns();
            } catch (error) {
                log('Failed to delete campaign: ' + error.message, 'error');
            }
        }

        document.getElementById('add-campaign-form').addEventListener('submit', createCampaign);

        // ---- Invoice Logic ----

        async function loadInvoices() {
            try {
                const invoices = await apiCall('/invoices');
                _invoicesCache = invoices || [];
                applySearch();
            } catch (error) {
                log('Failed to load invoices: ' + error.message, 'error');
            }
        }

        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoices-table');
            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No invoices yet.</td></tr>';
                return;
            }
            tbody.innerHTML = invoices.map(i => {
                const date = i.created_at ? new Date(i.created_at).toLocaleString() : 'N/A';
                const invoiceNum = 'INV-' + String(i.invoice_number).padStart(4, '0');
                const customerName = i.customer_snapshot.name + (i.customer_snapshot.company ? ` (${i.customer_snapshot.company})` : '');
                return `<tr>
                    <td>${date}</td>
                    <td><strong>${invoiceNum}</strong></td>
                    <td>${escapeHtml(customerName)}</td>
                    <td title="${i.order_id}">${i.order_id.substring(0, 8)}...</td>
                    <td class="price">$${i.grand_total.toFixed(2)}</td>
                    <td class="actions">
                        <button class="small secondary" onclick="viewInvoice('${i.id}')">View</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function viewInvoice(invoiceId) {
            try {
                const inv = await apiCall(`/invoices/${invoiceId}`);
                const cs = inv.customer_snapshot;
                const invoiceNum = 'INV-' + String(inv.invoice_number).padStart(4, '0');
                const date = new Date(inv.created_at).toLocaleDateString();

                let addressHtml = `<strong>${escapeHtml(cs.name)}</strong><br>`;
                if (cs.company) addressHtml += `${escapeHtml(cs.company)}<br>`;
                if (cs.shipping_street) addressHtml += `${escapeHtml(cs.shipping_street)}<br>`;
                if (cs.shipping_city || cs.shipping_state || cs.shipping_zip) {
                    addressHtml += `${escapeHtml(cs.shipping_city || '')}, ${escapeHtml(cs.shipping_state || '')} ${escapeHtml(cs.shipping_zip || '')}<br>`;
                }
                if (cs.shipping_country) addressHtml += `${escapeHtml(cs.shipping_country)}<br>`;
                if (cs.email) addressHtml += `${escapeHtml(cs.email)}<br>`;
                if (cs.phone) addressHtml += `${escapeHtml(cs.phone)}`;

                const itemsRows = inv.line_items.map(item => `
                    <tr>
                        <td>${escapeHtml(item.product_name)}</td>
                        <td>${escapeHtml(item.sku)}</td>
                        <td class="price">$${item.unit_price.toFixed(2)}</td>
                        <td>${item.quantity}</td>
                        <td class="price">$${item.line_total.toFixed(2)}</td>
                    </tr>
                `).join('');

                let totalsHtml = `<p>Subtotal: <strong class="price">$${inv.subtotal.toFixed(2)}</strong></p>`;
                if (inv.coupon_code && inv.discount_amount > 0) {
                    totalsHtml += `<p class="discount-line">Discount (${escapeHtml(inv.coupon_code)}): -$${inv.discount_amount.toFixed(2)}</p>`;
                }
                totalsHtml += `<p style="font-size:1.2rem;">Grand Total: <strong class="price">$${inv.grand_total.toFixed(2)}</strong></p>`;

                document.getElementById('invoice-content').innerHTML = `
                    <div id="invoice-printable">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem;">
                            <div>
                                <h3 style="margin:0;">Invoice ${invoiceNum}</h3>
                                <p style="color:var(--text-secondary); margin:0.25rem 0;">Date: ${date}</p>
                                <p style="color:var(--text-secondary); margin:0;">Order: ${inv.order_id.substring(0, 8)}...</p>
                            </div>
                            <div style="text-align:right;">
                                <h4 style="margin:0; color:var(--accent);">Darwin Store</h4>
                            </div>
                        </div>
                        <div style="margin-bottom:1.5rem; padding:1rem; background:var(--bg-card); border-radius:8px;">
                            <h4 style="margin:0 0 0.5rem; font-size:0.85rem; color:var(--text-secondary); text-transform:uppercase;">Bill To</h4>
                            ${addressHtml}
                        </div>
                        <table class="line-items-table" style="width:100%; margin-bottom:1rem;">
                            <thead>
                                <tr><th>Product</th><th>SKU</th><th>Unit Price</th><th>Qty</th><th>Total</th></tr>
                            </thead>
                            <tbody>${itemsRows}</tbody>
                        </table>
                        <div style="text-align:right; margin-top:1rem;">
                            ${totalsHtml}
                        </div>
                    </div>
                `;
                document.getElementById('invoice-modal').classList.add('active');
            } catch (error) {
                log(`Failed to load invoice: ${error.message}`, 'error');
            }
        }

        function printInvoice() {
            window.print();
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        // Close invoice modal on overlay click
        document.getElementById('invoice-modal').addEventListener('click', (e) => {
            if (e.target.id === 'invoice-modal') closeInvoiceModal();
        });

        // ---- Search Logic ----

        function applySearch() {
            const searchEl = document.getElementById('global-search');
            if (!searchEl) return;
            const query = searchEl.value.toLowerCase().trim();
            const activeTab = document.querySelector('.tab-pane.active')?.id;

            if (!query) {
                if (activeTab === 'inventory') {
                    renderInventory(_productsCache);
                } else if (activeTab === 'orders') {
                    renderOrdersFromCache(_ordersCache, _unassignedOrdersCache);
                } else if (activeTab === 'customers') {
                    renderCustomerList(_customersCache);
                } else if (activeTab === 'suppliers') {
                    renderSupplierList();
                } else if (activeTab === 'alerts') {
                    renderAlerts(_alertsCache);
                } else if (activeTab === 'invoices') {
                    renderInvoices(_invoicesCache);
                }
                return;
            }

            function matches(value) {
                return value != null && String(value).toLowerCase().includes(query);
            }

            if (activeTab === 'inventory') {
                const filtered = _productsCache.filter(p =>
                    matches(p.name) ||
                    matches(p.sku) ||
                    matches(p.description)
                );
                renderInventory(filtered);
            } else if (activeTab === 'orders') {
                const filterOrder = o =>
                    matches(o.id) ||
                    matches(o.status) ||
                    (o.total_amount != null && String(o.total_amount.toFixed(2)).includes(query));
                renderOrdersFromCache(
                    _ordersCache.filter(filterOrder),
                    _unassignedOrdersCache.filter(filterOrder)
                );
            } else if (activeTab === 'customers') {
                const filtered = _customersCache.filter(c =>
                    matches(c.name) ||
                    matches(c.email) ||
                    matches(c.company) ||
                    matches(c.phone)
                );
                renderCustomerList(filtered);
            } else if (activeTab === 'suppliers') {
                const filtered = _suppliersCache.filter(s =>
                    matches(s.name) ||
                    matches(s.contact_email) ||
                    matches(s.phone)
                );
                renderSupplierList(filtered);
            } else if (activeTab === 'alerts') {
                const filtered = _alertsCache.filter(a =>
                    matches(a.message) ||
                    matches(a.status)
                );
                renderAlerts(filtered);
            } else if (activeTab === 'invoices') {
                const filtered = _invoicesCache.filter(i =>
                    matches(i.invoice_number) ||
                    matches(i.customer_snapshot.name) ||
                    matches(i.customer_snapshot.company) ||
                    matches(i.order_id)
                );
                renderInvoices(filtered);
            }
        }

        document.getElementById('global-search').addEventListener('input', applySearch);

        // ---- Admin Logout ----

        async function adminLogout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
            } catch (e) {
                // Best effort
            }
            window.location.href = '/';
        }

        // ---- Settings: Change Password ----

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const current = document.getElementById('current-password').value;
            const newPw = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const msgEl = document.getElementById('password-change-msg');

            if (newPw !== confirm) {
                msgEl.textContent = 'New passwords do not match.';
                msgEl.style.color = 'var(--danger)';
                msgEl.style.display = 'block';
                return;
            }

            try {
                const resp = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: current, new_password: newPw })
                });
                if (resp.ok) {
                    msgEl.textContent = 'Password changed successfully.';
                    msgEl.style.color = 'var(--success)';
                    msgEl.style.display = 'block';
                    document.getElementById('change-password-form').reset();
                    log('Admin password changed', 'success');
                } else {
                    const err = await resp.json();
                    msgEl.textContent = err.detail || 'Failed to change password.';
                    msgEl.style.color = 'var(--danger)';
                    msgEl.style.display = 'block';
                }
            } catch (error) {
                msgEl.textContent = 'Failed to change password. Please try again.';
                msgEl.style.color = 'var(--danger)';
                msgEl.style.display = 'block';
            }
        });

        // ---- Initialization ----

        loadDashboard();
        loadSuppliers().then(() => loadProducts());
        updateAlertsBadge();
        setInterval(loadProducts, 5000);
        setInterval(loadSuppliers, 5000);
        setInterval(updateAlertsBadge, 10000);
        log('Darwin Store Admin initialized', 'success');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
