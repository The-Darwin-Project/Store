<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darwin Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/shared.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1>Darwin Store</h1>
                <button class="admin-login-btn" onclick="openLoginDialog()" title="Admin Login">Admin</button>
                <span class="cart-icon-wrapper" onclick="switchTab('cart')" title="View Cart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM7.16 14.26l.04-.12.96-1.74h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 20.12 3H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.44C4.52 14.37 5.48 16 7 16h12v-2H7.42c-.14 0-.25-.11-.25-.25z"/></svg>
                    <span class="cart-badge hidden" id="cart-badge">0</span>
                </span>
            </div>
            <p class="subtitle">Shop</p>
            <div class="search-bar" style="margin-top: 1rem;">
                <input type="text" id="global-search" placeholder="Search products..."
                       style="width: 100%; max-width: 500px;">
            </div>
        </header>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="catalog-tab" type="button" role="tab" onclick="switchTab('catalog')">Catalog</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cart-tab" type="button" role="tab" onclick="switchTab('cart')">Cart</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" type="button" role="tab" onclick="switchTab('orders')">My Orders</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Catalog Tab -->
            <div class="tab-pane active" id="catalog">
                <div class="catalog-grid" id="catalog-grid">
                    <div class="empty-state" style="grid-column: 1 / -1;">No products yet.</div>
                </div>
            </div>

            <!-- Cart Tab -->
            <div class="tab-pane" id="cart">
                <div class="panel">
                    <h2>Shopping Cart</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cart-table">
                                <tr><td colspan="5" class="empty-state">Your cart is empty.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="coupon-section" style="margin-top: 1rem; display: none;">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="coupon-input">Discount Code</label>
                                <input type="text" id="coupon-input" placeholder="Enter coupon code"
                                       style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <button type="button" class="secondary" onclick="applyCoupon()">Apply</button>
                            </div>
                            <div class="form-group">
                                <button type="button" class="small secondary" onclick="removeCoupon()"
                                        id="remove-coupon-btn" style="display: none;">Clear</button>
                            </div>
                        </div>
                        <div id="coupon-result" style="margin-top: 0.5rem;"></div>
                    </div>
                    <div id="cart-total" style="text-align: right; margin-top: 1rem; font-size: 1.25rem; font-weight: 700;"></div>
                    <div id="checkout-section" style="margin-top: 1.5rem; display: none;">
                        <div class="panel" style="margin-bottom: 1rem;">
                            <h2>Select Customer</h2>
                            <div class="form-row">
                                <div class="form-group flex-grow">
                                    <label for="checkout-customer">Customer</label>
                                    <select id="checkout-customer">
                                        <option value="">-- Select a customer --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="secondary" onclick="toggleNewCustomerForm()">New Customer</button>
                                </div>
                            </div>
                            <div id="inline-new-customer" class="new-customer-form" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group flex-grow">
                                        <label for="new-cust-name">Name</label>
                                        <input type="text" id="new-cust-name" placeholder="Customer name">
                                    </div>
                                    <div class="form-group flex-grow">
                                        <label for="new-cust-email">Email</label>
                                        <input type="email" id="new-cust-email" placeholder="customer@example.com">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" onclick="createInlineCustomer()">Create</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="checkout()" id="checkout-btn">Checkout</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Tab (My Orders - read-only) -->
            <div class="tab-pane" id="orders">
                <div class="panel">
                    <h2>My Orders</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order ID</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <tr><td colspan="4" class="empty-state">No orders yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="log-panel">
            <h2>Activity Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div class="modal-overlay" id="order-success-modal">
        <div class="custom-modal">
            <h3>Order Confirmed</h3>
            <p style="margin-bottom: 1rem; color: var(--success);">Your order has been placed successfully!</p>
            <div id="order-details" style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary);"></div>
            <div class="modal-actions">
                <button onclick="closeOrderModal()">Continue Shopping</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoice-modal">
        <div class="custom-modal" style="max-width: 700px;">
            <div id="invoice-content">
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeInvoiceModal()">Close</button>
                <button type="button" onclick="printInvoice()">Print</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal-overlay" id="login-modal">
        <div class="custom-modal">
            <h3>Admin Login</h3>
            <div id="login-error" style="color: var(--danger); margin-bottom: 1rem; display: none;"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter admin password" required
                           style="background: var(--bg-card); border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 1rem; width: 100%;">
                </div>
                <div class="modal-actions">
                    <button type="button" class="secondary" onclick="closeLoginDialog()">Cancel</button>
                    <button type="submit">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="product-detail-modal">
        <div class="custom-modal" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <div id="product-detail-content"></div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeProductDetail()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let _customersCache = [];

        // Utility: Log messages
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Star rating rendering
        function renderStars(rating, maxStars = 5) {
            let html = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating - fullStars >= 0.5;
            for (let i = 0; i < fullStars; i++) html += '<span class="star full">&#9733;</span>';
            if (halfStar) html += '<span class="star half">&#9733;</span>';
            const empty = maxStars - fullStars - (halfStar ? 1 : 0);
            for (let i = 0; i < empty; i++) html += '<span class="star empty">&#9734;</span>';
            return html;
        }

        // Ratings cache
        let _ratingsCache = {};

        async function loadRatings(productIds) {
            const promises = productIds.map(id =>
                apiCall('/products/' + id + '/average-rating').catch(() => ({ product_id: id, average_rating: 0, review_count: 0 }))
            );
            const results = await Promise.all(promises);
            results.forEach(r => { _ratingsCache[r.product_id] = r; });
        }

        // API helper with error handling
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(endpoint, options);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: response.statusText }));
                throw new Error(error.detail || 'Request failed');
            }

            if (response.status === 204) return null;
            return response.json();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            const searchEl = document.getElementById('global-search');
            if (searchEl) {
                const placeholders = {
                    catalog: 'Search products...',
                    cart: 'Search...',
                    orders: 'Search orders...'
                };
                searchEl.placeholder = placeholders[tabName] || 'Search...';
            }
            if (tabName === 'orders') loadOrders();
            if (tabName === 'cart') loadCustomerDropdown();
            applySearch();
        }

        // ---- Catalog Logic ----

        let _productsCache = [];

        async function loadProducts() {
            try {
                const products = await apiCall('/products');
                _productsCache = products || [];
                if (_productsCache.length > 0) {
                    await loadRatings(_productsCache.map(p => p.id));
                }
                renderCatalog(_productsCache);
                applySearch();
            } catch (error) {
                log(`Failed to load products: ${error.message}`, 'error');
            }
        }

        function renderCatalog(products) {
            const grid = document.getElementById('catalog-grid');

            if (!products || products.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">No products yet.</div>';
                return;
            }

            grid.innerHTML = products.map(p => {
                const imageHtml = p.image_data
                    ? `<img class="catalog-card-img" src="${p.image_data}" alt="${escapeHtml(p.name)}">`
                    : `<div class="catalog-card-img-placeholder">No Image</div>`;
                const badgeClass = p.stock > 0 ? 'in-stock' : 'out-of-stock';
                const badgeText = p.stock > 0 ? 'In Stock' : 'Out of Stock';

                const addBtnHtml = p.stock > 0
                    ? `<button class="btn-add-cart" onclick="event.stopPropagation(); addToCart('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', ${p.price})">Add to Cart</button>`
                    : '';

                const ratingData = _ratingsCache[p.id] || { average_rating: 0, review_count: 0 };
                const ratingHtml = `<div class="card-rating">${renderStars(ratingData.average_rating)} <span class="rating-count">(${ratingData.review_count})</span></div>`;

                return `
                    <div class="catalog-card" onclick="openProductDetail('${p.id}')" style="cursor:pointer;">
                        ${imageHtml}
                        <div class="catalog-card-body">
                            <h3>${escapeHtml(p.name)}</h3>
                            <div class="card-price">$${p.price.toFixed(2)}</div>
                            ${ratingHtml}
                            <span class="stock-badge ${badgeClass}">${badgeText}</span>
                            ${addBtnHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ---- Shopping Cart Logic ----

        let appliedCoupon = null;

        function getCart() {
            try {
                return JSON.parse(localStorage.getItem('darwin_cart')) || [];
            } catch {
                return [];
            }
        }

        function saveCart(cart) {
            localStorage.setItem('darwin_cart', JSON.stringify(cart));
        }

        function addToCart(productId, name, price) {
            const cart = getCart();
            const existing = cart.find(item => item.id === productId);
            if (existing) {
                existing.qty += 1;
            } else {
                cart.push({ id: productId, name, price, qty: 1 });
            }
            saveCart(cart);
            renderCartCount();
            renderCart();
            log(`Added "${name}" to cart`, 'success');
        }

        function updateCartQty(productId, delta) {
            const cart = getCart();
            const item = cart.find(i => i.id === productId);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) {
                removeFromCart(productId);
                return;
            }
            saveCart(cart);
            renderCart();
            renderCartCount();
        }

        function removeFromCart(productId) {
            let cart = getCart();
            const removed = cart.find(i => i.id === productId);
            cart = cart.filter(i => i.id !== productId);
            saveCart(cart);
            renderCart();
            renderCartCount();
            if (removed) log(`Removed "${removed.name}" from cart`, 'success');
        }

        function renderCart() {
            const cart = getCart();
            const tbody = document.getElementById('cart-table');
            const totalDiv = document.getElementById('cart-total');
            const checkoutSection = document.getElementById('checkout-section');
            const couponSection = document.getElementById('coupon-section');

            if (!cart.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Your cart is empty.</td></tr>';
                totalDiv.textContent = '';
                checkoutSection.style.display = 'none';
                couponSection.style.display = 'none';
                if (appliedCoupon) removeCoupon();
                return;
            }

            let grandTotal = 0;
            tbody.innerHTML = cart.map(item => {
                const subtotal = item.price * item.qty;
                grandTotal += subtotal;
                return `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td class="price">$${item.price.toFixed(2)}</td>
                        <td>
                            <div class="cart-qty-controls">
                                <button class="small secondary" onclick="updateCartQty('${item.id}', -1)">-</button>
                                <span>${item.qty}</span>
                                <button class="small secondary" onclick="updateCartQty('${item.id}', 1)">+</button>
                            </div>
                        </td>
                        <td class="price">$${subtotal.toFixed(2)}</td>
                        <td><button class="small danger" onclick="removeFromCart('${item.id}')">Remove</button></td>
                    </tr>
                `;
            }).join('');

            updateCartTotalDisplay(grandTotal);
            couponSection.style.display = 'block';
            checkoutSection.style.display = 'block';

            if (appliedCoupon) {
                revalidateCoupon(grandTotal);
            }
        }

        function renderCartCount() {
            const cart = getCart();
            const badge = document.getElementById('cart-badge');
            const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
            badge.textContent = totalItems;
            badge.classList.toggle('hidden', totalItems === 0);
        }

        // ---- Coupon Logic ----

        async function applyCoupon() {
            const code = document.getElementById('coupon-input').value.trim();
            if (!code) return;

            const cart = getCart();
            const cartTotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

            try {
                const result = await apiCall('/coupons/validate', 'POST', {
                    code: code,
                    cart_total: cartTotal
                });

                if (result.valid) {
                    appliedCoupon = {
                        code: result.coupon.code,
                        discount_amount: result.discount_amount,
                        final_total: result.final_total
                    };
                    renderCouponResult(true, `Coupon "${escapeHtml(result.coupon.code)}" applied: -$${result.discount_amount.toFixed(2)}`);
                    document.getElementById('remove-coupon-btn').style.display = '';
                    document.getElementById('coupon-input').disabled = true;
                } else {
                    appliedCoupon = null;
                    renderCouponResult(false, result.error);
                }
                renderCart();
            } catch (error) {
                renderCouponResult(false, error.message);
            }
        }

        function removeCoupon() {
            appliedCoupon = null;
            document.getElementById('coupon-input').value = '';
            document.getElementById('coupon-input').disabled = false;
            document.getElementById('remove-coupon-btn').style.display = 'none';
            document.getElementById('coupon-result').innerHTML = '';
            renderCart();
        }

        function renderCouponResult(success, message) {
            const div = document.getElementById('coupon-result');
            div.innerHTML = `<span class="${success ? 'coupon-success' : 'coupon-error'}">${escapeHtml(message)}</span>`;
        }

        async function revalidateCoupon(grandTotal) {
            if (!appliedCoupon || grandTotal <= 0) return;
            try {
                const result = await apiCall('/coupons/validate', 'POST', {
                    code: appliedCoupon.code, cart_total: grandTotal
                });
                if (result.valid) {
                    appliedCoupon.discount_amount = result.discount_amount;
                    appliedCoupon.final_total = result.final_total;
                    updateCartTotalDisplay(grandTotal);
                } else {
                    removeCoupon();
                    log('Coupon removed: ' + result.error, 'error');
                }
            } catch (e) {
                // Silently ignore re-validation errors
            }
        }

        function updateCartTotalDisplay(grandTotal) {
            const totalDiv = document.getElementById('cart-total');
            if (appliedCoupon) {
                totalDiv.innerHTML = `
                    Subtotal: <span class="price">$${grandTotal.toFixed(2)}</span><br>
                    <span class="discount-line">Discount (${escapeHtml(appliedCoupon.code)}): -$${appliedCoupon.discount_amount.toFixed(2)}</span><br>
                    Grand Total: <span class="price">$${appliedCoupon.final_total.toFixed(2)}</span>
                `;
            } else {
                totalDiv.innerHTML = `Grand Total: <span class="price">$${grandTotal.toFixed(2)}</span>`;
            }
        }

        // ---- Checkout Logic ----

        async function checkout() {
            const cart = getCart();
            if (!cart.length) {
                log('Cart is empty', 'error');
                return;
            }

            const customerId = document.getElementById('checkout-customer').value;
            if (!customerId) {
                log('Please select a customer before checking out', 'error');
                return;
            }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const items = cart.map(item => ({
                    product_id: item.id,
                    quantity: item.qty
                }));

                const payload = { items, customer_id: customerId };
                if (appliedCoupon) {
                    payload.coupon_code = appliedCoupon.code;
                }
                const order = await apiCall('/orders', 'POST', payload);

                // Clear coupon and cart
                appliedCoupon = null;
                saveCart([]);
                renderCart();
                renderCartCount();
                loadProducts();

                // Show success modal
                const detailsDiv = document.getElementById('order-details');
                let orderDetailsHtml = `
                    <p><strong>Order ID:</strong> ${order.id}</p>
                    <p><strong>Total:</strong> <span class="price">$${order.total_amount.toFixed(2)}</span></p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Items:</strong> ${order.items.length}</p>
                `;
                if (order.discount_amount > 0) {
                    orderDetailsHtml += `<p><strong>Discount:</strong> <span class="discount-line">-$${order.discount_amount.toFixed(2)}</span></p>`;
                }
                detailsDiv.innerHTML = orderDetailsHtml;
                document.getElementById('order-success-modal').classList.add('active');
                log(`Order placed successfully! Total: $${order.total_amount.toFixed(2)}`, 'success');
            } catch (error) {
                log(`Checkout failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Checkout';
            }
        }

        function closeOrderModal() {
            document.getElementById('order-success-modal').classList.remove('active');
            switchTab('catalog');
        }

        // Close order modal on overlay click
        document.getElementById('order-success-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-success-modal') {
                closeOrderModal();
            }
        });

        // ---- Customer Dropdown Logic ----

        async function loadCustomerDropdown() {
            try {
                const customers = await apiCall('/customers');
                _customersCache = customers || [];
                const select = document.getElementById('checkout-customer');
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- Select a customer --</option>';
                _customersCache.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.name} (${c.email})`;
                    select.appendChild(option);
                });
                if (currentVal && _customersCache.find(c => c.id === currentVal)) {
                    select.value = currentVal;
                }
            } catch (error) {
                log(`Failed to load customer list: ${error.message}`, 'error');
            }
        }

        function toggleNewCustomerForm() {
            const form = document.getElementById('inline-new-customer');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function createInlineCustomer() {
            const name = document.getElementById('new-cust-name').value.trim();
            const email = document.getElementById('new-cust-email').value.trim();
            if (!name || !email) {
                log('Customer name and email are required', 'error');
                return;
            }
            try {
                const customer = await apiCall('/customers', 'POST', { name, email });
                log(`Created customer: ${customer.name}`, 'success');
                document.getElementById('new-cust-name').value = '';
                document.getElementById('new-cust-email').value = '';
                document.getElementById('inline-new-customer').style.display = 'none';
                await loadCustomerDropdown();
                document.getElementById('checkout-customer').value = customer.id;
            } catch (error) {
                log(`Failed to create customer: ${error.message}`, 'error');
            }
        }

        // ---- My Orders Logic (read-only) ----

        let _ordersCache = [];

        function renderStatusBadge(status) {
            return `<span class="status-badge status-${escapeHtml(status)}">${escapeHtml(status)}</span>`;
        }

        function toggleOrderDetail(orderId) {
            const detailRow = document.getElementById('order-detail-' + orderId);
            if (detailRow) {
                detailRow.classList.toggle('expanded');
            }
        }

        function renderOrderDetail(order) {
            const customerName = order.customer_name
                ? escapeHtml(order.customer_name)
                : (order.customer_id ? 'Unknown customer' : 'No customer');

            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                const rows = order.items.map(item => {
                    const name = item.product_name ? escapeHtml(item.product_name) : 'Unknown product';
                    const lineTotal = (item.quantity * item.price_at_purchase).toFixed(2);
                    return `<tr>
                        <td>${name}</td>
                        <td>${item.quantity}</td>
                        <td class="price">$${item.price_at_purchase.toFixed(2)}</td>
                        <td class="price">$${lineTotal}</td>
                    </tr>`;
                }).join('');
                itemsHtml = `<table class="line-items-table">
                    <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>`;
            } else {
                itemsHtml = '<span style="color:var(--text-secondary)">No line items</span>';
            }

            let discountHtml = '';
            if (order.coupon_code && order.discount_amount > 0) {
                const subtotal = order.total_amount + order.discount_amount;
                discountHtml = `
                    <div class="discount-section">
                        <h4>Coupon Applied</h4>
                        <p>Code: <strong>${escapeHtml(order.coupon_code)}</strong></p>
                        <p>Subtotal: $${subtotal.toFixed(2)}</p>
                        <p class="discount-line">Discount: -$${order.discount_amount.toFixed(2)}</p>
                        <p>Final Total: <strong class="price">$${order.total_amount.toFixed(2)}</strong></p>
                    </div>`;
            }

            return `<td colspan="4" style="padding:0;">
                <div style="padding: 0.75rem 1rem 1rem;">
                    <div class="order-detail-content">
                        <div>
                            <h4>Line Items</h4>
                            ${itemsHtml}
                        </div>
                        <div>
                            <h4>Customer</h4>
                            <p>${customerName}</p>
                            ${discountHtml}
                        </div>
                    </div>
                </div>
            </td>`;
        }

        function renderStorefrontOrders(orders) {
            const tbody = document.getElementById('orders-table');
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No orders yet.</td></tr>';
                return;
            }
            tbody.innerHTML = orders.map(o => {
                const date = o.created_at ? new Date(o.created_at).toLocaleString() : 'N/A';
                const shortId = o.id.substring(0, 8);
                const invoiceBtn = (o.status === 'delivered' || o.status === 'returned') && o.invoice_id
                    ? `<button class="small secondary" onclick="event.stopPropagation(); viewInvoice('${o.invoice_id}')">View Invoice</button>`
                    : '';
                const reviewBtn = o.status === 'delivered' && o.items && o.items.length > 0
                    ? `<button class="small secondary" onclick="event.stopPropagation(); openProductDetail('${o.items[0].product_id}')">Review Products</button>`
                    : '';
                return `
                    <tr class="order-row" onclick="toggleOrderDetail('${o.id}')">
                        <td>${date}</td>
                        <td title="${o.id}">${shortId}...</td>
                        <td class="price">$${o.total_amount.toFixed(2)}</td>
                        <td>${renderStatusBadge(o.status)} ${invoiceBtn} ${reviewBtn}</td>
                    </tr>
                    <tr class="order-detail-row" id="order-detail-${o.id}">
                        ${renderOrderDetail(o)}
                    </tr>
                `;
            }).join('');
        }

        async function loadOrders() {
            try {
                const orders = await apiCall('/orders');
                _ordersCache = orders || [];
                applySearch();
            } catch (error) {
                log(`Failed to load orders: ${error.message}`, 'error');
                _ordersCache = [];
            }
        }

        // ---- Product Detail Modal ----

        let _selectedRating = 0;
        let _currentDetailProductId = null;

        async function openProductDetail(productId) {
            _currentDetailProductId = productId;
            const content = document.getElementById('product-detail-content');
            content.innerHTML = '<div class="empty-state">Loading...</div>';
            document.getElementById('product-detail-modal').classList.add('active');

            try {
                const [product, ratingData, reviews] = await Promise.all([
                    apiCall('/products/' + productId),
                    apiCall('/products/' + productId + '/average-rating'),
                    apiCall('/products/' + productId + '/reviews')
                ]);
                content.innerHTML = renderProductDetailContent(product, ratingData, reviews);
                loadReviewCustomerDropdown();
                renderStarPicker();
            } catch (error) {
                content.innerHTML = '<div class="empty-state" style="color:var(--danger);">Failed to load product details.</div>';
            }
        }

        function renderProductDetailContent(product, ratingData, reviews) {
            const imageHtml = product.image_data
                ? `<img src="${product.image_data}" alt="${escapeHtml(product.name)}" style="width:100%; max-height:250px; object-fit:cover; border-radius:8px; margin-bottom:1rem;">`
                : '';

            const reviewsHtml = reviews.length > 0
                ? reviews.map(r => {
                    const date = r.created_at ? new Date(r.created_at).toLocaleDateString() : '';
                    return `<div class="review-item">
                        <div class="review-header">
                            <span class="review-author">${escapeHtml(r.customer_name || 'Anonymous')}</span>
                            <span class="review-date">${date}</span>
                        </div>
                        <div>${renderStars(r.rating)}</div>
                        ${r.comment ? `<div class="review-comment">${escapeHtml(r.comment)}</div>` : ''}
                    </div>`;
                }).join('')
                : '<div class="empty-state" style="padding:1rem;">No reviews yet. Be the first to review this product!</div>';

            return `
                <div class="product-detail-header">
                    ${imageHtml}
                    <h3>${escapeHtml(product.name)}</h3>
                    <div class="product-detail-rating">
                        <span class="card-price" style="margin:0;">$${product.price.toFixed(2)}</span>
                        <span>${renderStars(ratingData.average_rating)}</span>
                        <span class="rating-count">(${ratingData.review_count} reviews)</span>
                    </div>
                    ${product.description ? `<div class="product-detail-description">${escapeHtml(product.description)}</div>` : ''}
                </div>
                <div class="reviews-section">
                    <h4>Customer Reviews</h4>
                    <div class="reviews-list">${reviewsHtml}</div>
                </div>
                <div class="review-form-section">
                    <h4>Write a Review</h4>
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="review-customer">
                            <option value="">-- Select a customer --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rating</label>
                        <div id="star-picker" class="star-picker"></div>
                    </div>
                    <div class="form-group">
                        <label>Comment (optional)</label>
                        <textarea id="review-comment" rows="3" maxlength="1000" placeholder="Share your experience..."></textarea>
                    </div>
                    <button onclick="submitReview('${product.id}')">Submit Review</button>
                </div>
            `;
        }

        function loadReviewCustomerDropdown() {
            const select = document.getElementById('review-customer');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select a customer --</option>';
            _customersCache.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name + ' (' + c.email + ')';
                select.appendChild(option);
            });
        }

        function renderStarPicker() {
            const container = document.getElementById('star-picker');
            if (!container) return;
            _selectedRating = 0;
            container.innerHTML = [1,2,3,4,5].map(n =>
                '<span class="star-pick" data-rating="' + n + '" onclick="setReviewRating(' + n + ')" ' +
                'onmouseenter="previewRating(' + n + ')" onmouseleave="resetRatingPreview()">&#9733;</span>'
            ).join('');
        }

        function setReviewRating(n) {
            _selectedRating = n;
            updateStarPickerDisplay(n);
        }

        function previewRating(n) {
            updateStarPickerDisplay(n);
        }

        function resetRatingPreview() {
            updateStarPickerDisplay(_selectedRating);
        }

        function updateStarPickerDisplay(activeCount) {
            const stars = document.querySelectorAll('#star-picker .star-pick');
            stars.forEach((star, i) => {
                if (i < activeCount) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        async function submitReview(productId) {
            const customerId = document.getElementById('review-customer').value;
            if (!customerId) {
                log('Please select a customer to submit a review', 'error');
                return;
            }
            if (_selectedRating === 0) {
                log('Please select a star rating', 'error');
                return;
            }
            const comment = document.getElementById('review-comment').value.trim();

            try {
                await apiCall('/products/' + productId + '/reviews', 'POST', {
                    customer_id: customerId,
                    rating: _selectedRating,
                    comment: comment
                });
                log('Review submitted successfully!', 'success');
                // Refresh ratings cache and reopen modal
                await loadRatings([productId]);
                renderCatalog(_productsCache);
                applySearch();
                await openProductDetail(productId);
            } catch (error) {
                log('Review failed: ' + error.message, 'error');
            }
        }

        function closeProductDetail() {
            document.getElementById('product-detail-modal').classList.remove('active');
            _selectedRating = 0;
            _currentDetailProductId = null;
        }

        // Close product detail modal on overlay click
        document.getElementById('product-detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'product-detail-modal') closeProductDetail();
        });

        // ---- Invoice Viewing ----

        async function viewInvoice(invoiceId) {
            try {
                const inv = await apiCall(`/invoices/${invoiceId}`);
                const cs = inv.customer_snapshot;
                const invoiceNum = 'INV-' + String(inv.invoice_number).padStart(4, '0');
                const date = new Date(inv.created_at).toLocaleDateString();

                let addressHtml = `<strong>${escapeHtml(cs.name)}</strong><br>`;
                if (cs.company) addressHtml += `${escapeHtml(cs.company)}<br>`;
                if (cs.shipping_street) addressHtml += `${escapeHtml(cs.shipping_street)}<br>`;
                if (cs.shipping_city || cs.shipping_state || cs.shipping_zip) {
                    addressHtml += `${escapeHtml(cs.shipping_city || '')}, ${escapeHtml(cs.shipping_state || '')} ${escapeHtml(cs.shipping_zip || '')}<br>`;
                }
                if (cs.shipping_country) addressHtml += `${escapeHtml(cs.shipping_country)}<br>`;
                if (cs.email) addressHtml += `${escapeHtml(cs.email)}<br>`;
                if (cs.phone) addressHtml += `${escapeHtml(cs.phone)}`;

                const itemsRows = inv.line_items.map(item => `
                    <tr>
                        <td>${escapeHtml(item.product_name)}</td>
                        <td>${escapeHtml(item.sku)}</td>
                        <td class="price">$${item.unit_price.toFixed(2)}</td>
                        <td>${item.quantity}</td>
                        <td class="price">$${item.line_total.toFixed(2)}</td>
                    </tr>
                `).join('');

                let totalsHtml = `<p>Subtotal: <strong class="price">$${inv.subtotal.toFixed(2)}</strong></p>`;
                if (inv.coupon_code && inv.discount_amount > 0) {
                    totalsHtml += `<p class="discount-line">Discount (${escapeHtml(inv.coupon_code)}): -$${inv.discount_amount.toFixed(2)}</p>`;
                }
                totalsHtml += `<p style="font-size:1.2rem;">Grand Total: <strong class="price">$${inv.grand_total.toFixed(2)}</strong></p>`;

                document.getElementById('invoice-content').innerHTML = `
                    <div id="invoice-printable">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem;">
                            <div>
                                <h3 style="margin:0;">Invoice ${invoiceNum}</h3>
                                <p style="color:var(--text-secondary); margin:0.25rem 0;">Date: ${date}</p>
                                <p style="color:var(--text-secondary); margin:0;">Order: ${inv.order_id.substring(0, 8)}...</p>
                            </div>
                            <div style="text-align:right;">
                                <h4 style="margin:0; color:var(--accent);">Darwin Store</h4>
                            </div>
                        </div>
                        <div style="margin-bottom:1.5rem; padding:1rem; background:var(--bg-card); border-radius:8px;">
                            <h4 style="margin:0 0 0.5rem; font-size:0.85rem; color:var(--text-secondary); text-transform:uppercase;">Bill To</h4>
                            ${addressHtml}
                        </div>
                        <table class="line-items-table" style="width:100%; margin-bottom:1rem;">
                            <thead>
                                <tr><th>Product</th><th>SKU</th><th>Unit Price</th><th>Qty</th><th>Total</th></tr>
                            </thead>
                            <tbody>${itemsRows}</tbody>
                        </table>
                        <div style="text-align:right; margin-top:1rem;">
                            ${totalsHtml}
                        </div>
                    </div>
                `;
                document.getElementById('invoice-modal').classList.add('active');
            } catch (error) {
                log(`Failed to load invoice: ${error.message}`, 'error');
            }
        }

        function printInvoice() {
            window.print();
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        // Close invoice modal on overlay click
        document.getElementById('invoice-modal').addEventListener('click', (e) => {
            if (e.target.id === 'invoice-modal') closeInvoiceModal();
        });

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProductDetail();
                closeInvoiceModal();
                closeLoginDialog();
            }
        });

        // ---- Search Logic ----

        function applySearch() {
            const searchEl = document.getElementById('global-search');
            if (!searchEl) return;
            const query = searchEl.value.toLowerCase().trim();
            const activeTab = document.querySelector('.tab-pane.active')?.id;

            if (!query) {
                if (activeTab === 'catalog') {
                    renderCatalog(_productsCache);
                } else if (activeTab === 'orders') {
                    renderStorefrontOrders(_ordersCache);
                }
                return;
            }

            function matches(value) {
                return value != null && String(value).toLowerCase().includes(query);
            }

            if (activeTab === 'catalog') {
                const filtered = _productsCache.filter(p =>
                    matches(p.name) ||
                    matches(p.sku) ||
                    matches(p.description)
                );
                renderCatalog(filtered);
            } else if (activeTab === 'orders') {
                const filtered = _ordersCache.filter(o =>
                    matches(o.id) ||
                    matches(o.status) ||
                    (o.total_amount != null && String(o.total_amount.toFixed(2)).includes(query))
                );
                renderStorefrontOrders(filtered);
            }
        }

        document.getElementById('global-search').addEventListener('input', applySearch);

        // ---- Admin Login ----

        function openLoginDialog() {
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-password').value = '';
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('login-password').focus();
        }

        function closeLoginDialog() {
            document.getElementById('login-modal').classList.remove('active');
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('login-password').value;
            try {
                const resp = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (resp.ok) {
                    window.location.href = '/admin';
                } else {
                    const err = await resp.json();
                    const errEl = document.getElementById('login-error');
                    errEl.textContent = err.detail || 'Invalid password';
                    errEl.style.display = 'block';
                }
            } catch (error) {
                const errEl = document.getElementById('login-error');
                errEl.textContent = 'Login failed. Please try again.';
                errEl.style.display = 'block';
            }
        });

        document.getElementById('login-modal').addEventListener('click', (e) => {
            if (e.target.id === 'login-modal') closeLoginDialog();
        });

        // Check for auth redirect error
        if (new URLSearchParams(window.location.search).get('auth_error')) {
            log('Please log in to access the admin panel', 'error');
            window.history.replaceState({}, '', '/');
        }

        // ---- Initialization ----

        loadProducts();
        renderCart();
        renderCartCount();
        loadCustomerDropdown();
        setInterval(loadProducts, 5000);
        log('Darwin Store initialized', 'success');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
