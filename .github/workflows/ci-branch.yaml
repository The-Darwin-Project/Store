# Store/.github/workflows/ci-branch.yaml
# CI validation for agent feature branches (feat/*)
# On success: auto-creates PR and merges to main
# Main branch build-push.yaml then builds the image + updates helm tag
#
# Flow: Agent pushes to feat/evt-xxx → CI validates → auto-merge to main → build-push triggers

name: Branch CI + Auto-Merge

on:
  push:
    branches:
      - "feat/**"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Validate Docker image builds
        run: |
          echo "Building Docker image to validate branch changes..."
          docker build -f Dockerfile -t ci-validate:${{ github.sha }} .
          echo "Docker build validation passed"

      - name: Check for helm values.yaml conflicts
        run: |
          # Ensure the branch hasn't accidentally modified the image tag
          # (CI manages this on main only)
          git fetch origin main
          MAIN_TAG=$(git show origin/main:helm/values.yaml | grep 'tag:' | head -1 | awk '{print $2}' | tr -d '"')
          BRANCH_TAG=$(grep 'tag:' helm/values.yaml | head -1 | awk '{print $2}' | tr -d '"')
          if [ "$MAIN_TAG" != "$BRANCH_TAG" ]; then
            echo "WARNING: Branch modified image.tag ($BRANCH_TAG vs main's $MAIN_TAG)"
            echo "Resetting image.tag to main's value to prevent CI tag overwrite"
            git checkout origin/main -- helm/values.yaml
          fi

      - name: Summary
        run: |
          echo "## Branch CI Passed" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY

  auto-merge:
    needs: validate
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # GitHub App authentication (if configured)
      - name: Generate GitHub App Token
        id: app-token
        if: vars.USE_GITHUB_APP == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DARWIN_APP_ID }}
          private-key: ${{ secrets.DARWIN_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ vars.USE_GITHUB_APP == 'true' && steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: Reset helm values.yaml to main
        run: |
          # Prevent agent branches from overwriting CI-managed image tag
          git fetch origin main
          if ! git diff --quiet origin/main -- helm/values.yaml; then
            echo "Resetting helm/values.yaml to main's version (agent should not modify image tag)"
            git checkout origin/main -- helm/values.yaml
            git add helm/values.yaml
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git diff --cached --quiet || git commit -m "ci: reset helm values.yaml to main [skip ci]"
            git push
          fi

      - name: Create PR and auto-merge
        env:
          GH_TOKEN: ${{ vars.USE_GITHUB_APP == 'true' && steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.ref_name }}"
          
          # Create PR if it doesn't exist
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "Auto: ${BRANCH}" \
              --body "Automated PR from Darwin agent branch. CI validated." \
              --head "$BRANCH" \
              --base main
          fi
          
          # Merge immediately (CI already passed in the validate job)
          # Use --admin to bypass branch protection checks (validate job is the CI gate)
          # Retry with delays in case PR status is still propagating
          MERGED=false
          for i in 1 2 3; do
            if gh pr merge "$BRANCH" --merge --delete-branch --admin 2>/dev/null; then
              MERGED=true
              break
            fi
            echo "Merge attempt $i failed, retrying in 10s..."
            sleep 10
          done
          
          if [ "$MERGED" = "false" ]; then
            # Fallback: try without --admin (in case App doesn't have admin)
            gh pr merge "$BRANCH" --merge --delete-branch || echo "WARNING: Auto-merge failed"
          fi
          
          echo "## Auto-Merged" >> $GITHUB_STEP_SUMMARY
          echo "Branch **${BRANCH}** merged to main" >> $GITHUB_STEP_SUMMARY
