# Store/.github/workflows/ci-branch.yaml
# CI validation for agent feature branches (feat/*)
# On success: auto-creates PR and merges to main
# Main branch build-push.yaml then builds the image + updates helm tag
#
# Flow: Agent pushes to feat/evt-xxx → CI validates + tests → auto-merge to main → build-push triggers
#
# Quality gates (all must pass before auto-merge):
#   1. validate: Docker build + Helm tag safety
#   2. test-python: pytest unit tests (FastAPI TestClient, mocked DB)
#   3. test-playwright: Self-contained UI tests (route-mocked, no server needed)

name: Branch CI + Auto-Merge

on:
  push:
    branches:
      - "feat/**"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Validate Docker image builds
        run: |
          echo "Building Docker images to validate branch changes..."
          docker build -f Dockerfile.frontend -t ci-frontend:${{ github.sha }} .
          docker build -f Dockerfile.backend -t ci-backend:${{ github.sha }} .
          docker build -f Dockerfile.chaos -t ci-chaos:${{ github.sha }} .
          echo "Docker build validation passed (all 3 images)"

      - name: Install yq
        uses: mikefarah/yq@master

      - name: Check for helm values.yaml conflicts
        run: |
          git fetch origin main
          MAIN_FRONTEND_TAG=$(git show origin/main:helm/values.yaml | yq '.image.frontend.tag')
          MAIN_BACKEND_TAG=$(git show origin/main:helm/values.yaml | yq '.image.backend.tag')
          MAIN_CHAOS_TAG=$(git show origin/main:helm/values.yaml | yq '.image.chaos.tag')
          BRANCH_FRONTEND_TAG=$(yq '.image.frontend.tag' helm/values.yaml)
          BRANCH_BACKEND_TAG=$(yq '.image.backend.tag' helm/values.yaml)
          BRANCH_CHAOS_TAG=$(yq '.image.chaos.tag' helm/values.yaml)
          TAGS_CHANGED=false
          if [ "$MAIN_FRONTEND_TAG" != "$BRANCH_FRONTEND_TAG" ] || \
             [ "$MAIN_BACKEND_TAG" != "$BRANCH_BACKEND_TAG" ] || \
             [ "$MAIN_CHAOS_TAG" != "$BRANCH_CHAOS_TAG" ]; then
            echo "WARNING: Branch modified image tags — resetting to main's values"
            yq -i ".image.frontend.tag = \"$MAIN_FRONTEND_TAG\"" helm/values.yaml
            yq -i ".image.backend.tag = \"$MAIN_BACKEND_TAG\"" helm/values.yaml
            yq -i ".image.chaos.tag = \"$MAIN_CHAOS_TAG\"" helm/values.yaml
            TAGS_CHANGED=true
          fi
          echo "Image tags validated (changed=$TAGS_CHANGED)"

      - name: Summary
        run: |
          echo "## Branch CI Passed" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY

  test-python:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements-test.txt

      - name: Run pytest
        run: |
          python -m pytest \
            tests/test_model.py \
            tests/test_html_structure.py \
            tests/test_order_history.py \
            tests/test_orders_qe.py \
            tests/test_orders_uuid_fix.py \
            tests/test_order_status.py \
            tests/test_uuid_cast_fix.py \
            tests/test_customers_qe.py \
            tests/test_redesign.py \
            tests/test_unassigned_orders.py \
            tests/verify_customers_api.py \
            tests/test_reviews.py \
            tests/test_campaigns.py \
            -v --tb=short

      - name: Test summary
        if: always()
        run: |
          echo "## Python Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  test-playwright:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run self-contained Playwright tests
        run: npm test

      - name: Test summary
        if: always()
        run: |
          echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  auto-merge:
    needs: [validate, test-python, test-playwright]
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        id: app-token
        if: vars.USE_GITHUB_APP == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DARWIN_APP_ID }}
          private-key: ${{ secrets.DARWIN_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ vars.USE_GITHUB_APP == 'true' && steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: Install yq
        uses: mikefarah/yq@master

      - name: Reset image tags to main (preserve other values.yaml changes)
        run: |
          git fetch origin main
          MAIN_FRONTEND_TAG=$(git show origin/main:helm/values.yaml | yq '.image.frontend.tag')
          MAIN_BACKEND_TAG=$(git show origin/main:helm/values.yaml | yq '.image.backend.tag')
          MAIN_CHAOS_TAG=$(git show origin/main:helm/values.yaml | yq '.image.chaos.tag')
          yq -i ".image.frontend.tag = \"$MAIN_FRONTEND_TAG\"" helm/values.yaml
          yq -i ".image.backend.tag = \"$MAIN_BACKEND_TAG\"" helm/values.yaml
          yq -i ".image.chaos.tag = \"$MAIN_CHAOS_TAG\"" helm/values.yaml
          if ! git diff --quiet helm/values.yaml; then
            git add helm/values.yaml
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "ci: reset image tags to main [skip ci]"
            git push
          fi

      - name: Create PR and auto-merge
        env:
          GH_TOKEN: ${{ vars.USE_GITHUB_APP == 'true' && steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.ref_name }}"
          
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "Auto: ${BRANCH}" \
              --body "Automated PR from Darwin agent branch. CI validated (Docker build + pytest + Playwright)." \
              --head "$BRANCH" \
              --base main
          fi
          
          MERGED=false
          for i in 1 2 3; do
            if gh pr merge "$BRANCH" --merge --delete-branch --admin 2>/dev/null; then
              MERGED=true
              break
            fi
            echo "Merge attempt $i failed, retrying in 10s..."
            sleep 10
          done
          
          if [ "$MERGED" = "false" ]; then
            gh pr merge "$BRANCH" --merge --delete-branch || echo "WARNING: Auto-merge failed"
          fi
          
          echo "## Auto-Merged" >> $GITHUB_STEP_SUMMARY
          echo "Branch **${BRANCH}** merged to main" >> $GITHUB_STEP_SUMMARY
